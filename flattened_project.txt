=== ./index.tsx ===

import './utils/polyfill';
import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App';

const rootElement = document.getElementById('root');
if (!rootElement) {
  throw new Error("Could not find root element to mount to");
}

const root = ReactDOM.createRoot(rootElement);
root.render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
);


=== ./App.tsx ===

import React, { useState, useEffect, FormEvent, useRef, ChangeEvent } from 'react';
import {
  signInWithGoogle,
  logout,
  fetchPulses,
  mintPulse,
  lovePulse,
  isPulseLoved,
  onAuthChange,
  fetchLifetrees,
  plantLifetree,
  getMyLifetrees,
  uploadImage,
  uploadBase64Image,
  validateLifetree,
  proposeMatch,
  getPendingMatches,
  acceptMatch,
  fetchGrowthPulses,
  getMyPulses,
  getMyMatchesHistory,
  fetchVisions,
  createVision,
  getMyVisions
} from './services/firebase';
import { generateLifetreeBio, generateVisionImage, createOracleChat } from './services/gemini';
import { type Lightseed, type Pulse, type Lifetree, type MatchProposal, type Vision } from './types';
import Logo from './components/Logo';
import { LanguageProvider, useLanguage } from './contexts/LanguageContext';
import { type Language } from './utils/translations';
import { Chat, GenerateContentResponse } from "@google/genai";

// --- THEME ---
const colors = {
  sky: "bg-slate-800", 
  earth: "bg-[#92400E]", 
  grass: "bg-[#65A30D]",
  snow: "bg-[#F8FAFC]",
  sun: "bg-[#F59E0B]", // Amber 500
};

// --- ANIMATIONS ---
const PulsatingDot = () => (
    <span className="relative flex h-3 w-3 mr-2">
      <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
      <span className="relative inline-flex rounded-full h-3 w-3 bg-emerald-500"></span>
    </span>
);

const Icons = {
  Heart: ({ filled }: { filled: boolean }) => (
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill={filled ? "#EF4444" : "none"} stroke="currentColor" strokeWidth="2" className={`w-5 h-5 ${filled ? 'text-red-500' : 'text-slate-400'}`}>
      <path strokeLinecap="round" strokeLinejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" />
    </svg>
  ),
  Hash: () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-4 h-4 text-slate-400"><path strokeLinecap="round" strokeLinejoin="round" d="M5.25 8.25h15m-16.5 7.5h15m-1.8-13.5l-3.9 19.5m-2.1-19.5l-3.9 19.5" /></svg>,
  Loc: () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-4 h-4"><path strokeLinecap="round" strokeLinejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z" /></svg>,
  Menu: () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-6 h-6"><path strokeLinecap="round" strokeLinejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg>,
  Close: () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-6 h-6"><path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>,
  Map: () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5"><path strokeLinecap="round" strokeLinejoin="round" d="M9 6.75V15m6-6v8.25m.503 3.498l4.875-2.437c.381-.19.622-.58.622-1.006V4.82c0-.836-.88-1.38-1.628-1.006l-3.869 1.934c-.317.159-.69.159-1.006 0L9.503 3.252a1.125 1.125 0 00-1.006 0L3.622 5.689C3.24 5.88 3 6.27 3 6.695V19.18c0 .836.88 1.38 1.628 1.006l3.869-1.934c.317-.159.69-.159 1.006 0l4.994 2.497c.317.158.69.158 1.006 0z" /></svg>,
  List: () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5"><path strokeLinecap="round" strokeLinejoin="round" d="M8.25 6.75h12M8.25 12h12m-12 5.25h12M3.75 6.75h.007v.008H3.75V6.75zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zM3.75 12h.007v.008H3.75V12zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm-.375 5.25h.007v.008H3.75v-.008zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" /></svg>,
  Camera: () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5"><path strokeLinecap="round" strokeLinejoin="round" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.774 48.774 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z" /><path strokeLinecap="round" strokeLinejoin="round" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18.75 10.5h.008v.008h-.008V10.5z" /></svg>,
  ShieldCheck: () => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-4 h-4 text-emerald-500"><path fillRule="evenodd" d="M12.516 2.17a.75.75 0 00-1.032 0 11.209 11.209 0 01-7.877 3.08.75.75 0 00-.722.515A12.74 12.74 0 002.25 9.75c0 5.942 4.064 10.933 9.563 12.348a.749.749 0 00.374 0c5.499-1.415 9.563-6.406 9.563-12.348 0-1.39-.223-2.73-.635-3.985a.75.75 0 00-.722-.516l-.143.001c-2.996 0-5.717-1.1-7.734-3.08zm3.094 8.016a.75.75 0 10-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 00-1.06 1.06l2.25 2.25a.75.75 0 001.14-.094l3.75-5.25z" clipRule="evenodd" /></svg>,
  Play: () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5"><path strokeLinecap="round" strokeLinejoin="round" d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.348a1.125 1.125 0 010 1.971l-11.54 6.347a1.125 1.125 0 01-1.667-.985V5.653z" /></svg>,
  Link: () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5"><path strokeLinecap="round" strokeLinejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244" /></svg>,
  ArrowLeft: () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5"><path strokeLinecap="round" strokeLinejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" /></svg>,
  FingerPrint: () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5"><path strokeLinecap="round" strokeLinejoin="round" d="M7.875 14.25l1.214 1.942a2.25 2.25 0 001.908 1.058h2.006c.776 0 1.497-.4 1.908-1.058l1.214-1.942M2.41 9a4.5 4.5 0 016.398-3.412 6 6 0 014.866 2.318A6 6 0 0118.665 4.5 6 6 0 0121.75 9v12a2.25 2.25 0 01-2.25 2.25h-15A2.25 2.25 0 012.25 21V9z" /></svg>,
  Search: () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5"><path strokeLinecap="round" strokeLinejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" /></svg>,
  Sparkles: () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5"><path strokeLinecap="round" strokeLinejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 001.423 1.423l1.183.394-1.183.394a2.25 2.25 0 00-1.423 1.423z" /></svg>,
  Globe: () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5"><path strokeLinecap="round" strokeLinejoin="round" d="M12 21a9.004 9.004 0 008.716-6.747M12 21a9.004 9.004 0 01-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 017.843 4.582M12 3a8.997 8.997 0 00-7.843 4.582m15.686 0A11.953 11.953 0 0112 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0121 12c0 .778-.099 1.533-.284 2.253m0 0A17.919 17.919 0 0112 16.5c-3.162 0-6.133-.815-8.716-2.247m0 0A9.015 9.015 0 013 12c0-1.605.42-3.113 1.157-4.418" /></svg>,
  Key: () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5"><path strokeLinecap="round" strokeLinejoin="round" d="M15.75 5.25a3 3 0 013 3m3 0a6 6 0 01-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1121.75 8.25z" /></svg>,
  Send: () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5"><path strokeLinecap="round" strokeLinejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" /></svg>,
  SparkleFill: () => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-5 h-5"><path fillRule="evenodd" d="M9 4.5a.75.75 0 01.721.544l.813 2.846a3.75 3.75 0 002.576 2.576l2.846.813a.75.75 0 010 1.442l-2.846.813a3.75 3.75 0 00-2.576 2.576l-.813 2.846a.75.75 0 01-1.442 0l-.813-2.846a3.75 3.75 0 00-2.576-2.576l-2.846-.813a.75.75 0 010-1.442l2.846-.813a3.75 3.75 0 002.576-2.576l.813-2.846A.75.75 0 019 4.5zM18 1.5a.75.75 0 01.728.568l.258 1.036c.236.94.97 1.674 1.91 1.91l1.036.258a.75.75 0 010 1.456l-1.036.258c-.94.236-1.674.97-1.91 1.91l-.258 1.036a.75.75 0 01-1.456 0l-.258-1.036a2.625 2.625 0 00-1.91-1.91l-1.036-.258a.75.75 0 010-1.456l1.036-.258a2.625 2.625 0 001.91-1.91l.258-1.036A.75.75 0 0118 1.5zM16.5 15a.75.75 0 01.712.513l.394 1.183c.15.447.5.799.948.948l1.183.394a.75.75 0 010 1.422l-1.183.394c-.447.15-.799.5-.948.948l-.394 1.183a.75.75 0 01-1.422 0l-.394-1.183a1.5 1.5 0 00-.948-.948l-1.183-.394a.75.75 0 010-1.422l1.183-.394a1.5 1.5 0 00.948-.948l.394-1.183A.75.75 0 0116.5 15z" clipRule="evenodd" /></svg>
};

const useLifeseed = () => {
    const [lightseed, setLightseed] = useState<Lightseed | null>(null);
    const [myTrees, setMyTrees] = useState<Lifetree[]>([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        const unsub = onAuthChange(async (user) => {
            if (user) {
                setLightseed({ 
                    uid: user.uid, 
                    email: user.email, 
                    displayName: user.displayName,
                    photoURL: user.photoURL 
                });
                const trees = await getMyLifetrees(user.uid);
                setMyTrees(trees);
            } else {
                setLightseed(null);
                setMyTrees([]);
            }
            setLoading(false);
        });
        return () => unsub();
    }, []);

    const refreshTrees = async () => {
        if (lightseed) {
            const trees = await getMyLifetrees(lightseed.uid);
            setMyTrees(trees);
        }
    }
    const activeTree = myTrees.length > 0 ? myTrees[0] : null;
    return { lightseed, myTrees, activeTree, loading, refreshTrees };
};

const Navigation = ({ lightseed, activeTab, setTab, onPlant, onPulse, onLogin, onLogout, onProfile, onCreateVision }: any) => {
    const { t, language, setLanguage } = useLanguage();
    const [isMenuOpen, setIsMenuOpen] = useState(false);
    const [hasApiKey, setHasApiKey] = useState(false); // Default to false until checked

    useEffect(() => {
        const checkKey = async () => {
             const aiStudio = (window as any).aistudio;
             if (aiStudio && aiStudio.hasSelectedApiKey) {
                 const has = await aiStudio.hasSelectedApiKey();
                 setHasApiKey(has);
             } else {
                 // If not in AI Studio environment, check process.env
                 setHasApiKey(!!process.env.API_KEY);
             }
        }
        checkKey();
    }, []);

    const handleApiKeySelect = async () => {
        const aiStudio = (window as any).aistudio;
        if (aiStudio) {
            try {
                await aiStudio.openSelectKey();
                // Re-check after selection
                const has = await aiStudio.hasSelectedApiKey();
                setHasApiKey(has);
            } catch (e) {
                console.error("API Key selection cancelled or failed", e);
            }
        } else {
            alert("Local environment detected. Please set API_KEY in your .env file.");
        }
    }
    
    // Helper to get active button style
    const getTabStyle = (key: string) => {
        if (activeTab === key) {
            if (key === 'visions') return `bg-amber-500 text-white shadow-lg shadow-amber-500/30`;
            if (key === 'forest') return `bg-emerald-600 text-white shadow-lg shadow-emerald-500/30`;
            if (key === 'pulses') return `bg-sky-600 text-white shadow-lg shadow-sky-500/30`;
            if (key === 'oracle') return `bg-indigo-600 text-white shadow-lg shadow-indigo-500/30`;
            return `bg-slate-700 text-white`;
        }
        return `text-slate-300 hover:text-white hover:bg-white/5`;
    }

    return (
        <nav className={`sticky top-0 z-30 bg-slate-900 border-b border-slate-800 text-white backdrop-blur-md bg-opacity-95`}>
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div className="flex justify-between h-20 items-center">
                    <div className="flex items-center space-x-3 cursor-pointer rtl:space-x-reverse" onClick={() => setTab('forest')}>
                        <div className="bg-white p-1 rounded-full shadow-inner animate-[pulse_3s_ease-in-out_infinite]">
                             <Logo width={40} height={40} />
                        </div>
                        <span className="font-light text-2xl tracking-wide lowercase hidden sm:block text-white">lifeseed</span>
                    </div>

                    <div className="hidden md:flex space-x-3 rtl:space-x-reverse">
                        {['forest', 'pulses', 'visions', 'oracle', 'matches'].map((tabKey) => (
                            <button 
                                key={tabKey}
                                onClick={() => setTab(tabKey)}
                                className={`px-4 py-2 rounded-full text-sm font-medium transition-all duration-300 ${getTabStyle(tabKey)}`}
                            >
                                {tabKey === 'matches' ? 'Matches' : t(tabKey as any)}
                            </button>
                        ))}
                    </div>

                    <div className="hidden md:flex items-center space-x-4 rtl:space-x-reverse">
                         <button 
                             onClick={handleApiKeySelect}
                             className={`p-2 rounded-full transition-all flex items-center space-x-2 ${!hasApiKey ? 'bg-amber-500/20 text-amber-500 animate-pulse ring-1 ring-amber-500' : 'text-slate-400 hover:text-white hover:bg-white/10'}`}
                             title={hasApiKey ? "Gemini Connected" : "Connect Gemini API"}
                         >
                             <Icons.Key />
                             {!hasApiKey && <span className="text-xs font-bold">Connect AI</span>}
                         </button>

                         <select 
                            value={language} 
                            onChange={(e) => setLanguage(e.target.value as Language)}
                            className="bg-black/20 text-white text-xs rounded border-none py-1 pl-2 pr-6 cursor-pointer"
                        >
                            <option value="en">EN</option>
                            <option value="es">ES</option>
                            <option value="hu">HU</option>
                            <option value="qu">QU</option>
                            <option value="sa">SA</option>
                            <option value="ja">JA</option>
                            <option value="ar">AR</option>
                        </select>

                        {lightseed ? (
                            <>
                                {activeTab === 'visions' ? (
                                     <button onClick={onCreateVision} className={`hidden sm:flex ${colors.earth} hover:bg-[#78350f] text-white px-5 py-2 rounded-full text-sm font-medium shadow-md transition-transform active:scale-95 items-center`}>
                                        {t('create_vision')}
                                    </button>
                                ) : (
                                    <button onClick={onPulse} className={`hidden sm:flex ${colors.earth} hover:bg-[#78350f] text-white px-5 py-2 rounded-full text-sm font-medium shadow-md transition-transform active:scale-95 items-center`}>
                                        <PulsatingDot />
                                        {t('emit_pulse')}
                                    </button>
                                )}
                                
                                <img 
                                    src={lightseed.photoURL || `https://ui-avatars.com/api/?name=${lightseed.displayName}`} 
                                    className="w-9 h-9 rounded-full border-2 border-white/50 cursor-pointer hover:border-white transition-colors" 
                                    alt="Seed" 
                                    onClick={onProfile}
                                />
                                <button onClick={onLogout} className="text-white/80 hover:text-white text-sm">{t('sign_out')}</button>
                            </>
                        ) : (
                            <button onClick={onLogin} className={`flex items-center space-x-2 rtl:space-x-reverse bg-white text-slate-900 px-5 py-2 rounded-full text-sm font-bold shadow-md hover:bg-slate-100 transition-colors`}>
                                <span>{t('sign_in')}</span>
                            </button>
                        )}
                    </div>

                    <div className="flex md:hidden items-center space-x-4 rtl:space-x-reverse">
                         <button 
                             onClick={handleApiKeySelect}
                             className={`p-1 ${!hasApiKey ? 'text-amber-500 animate-pulse' : 'text-slate-400'}`}
                         >
                             <Icons.Key />
                         </button>
                        <select 
                            value={language} 
                            onChange={(e) => setLanguage(e.target.value as Language)}
                            className="bg-black/20 text-white text-xs rounded border-none py-1 pl-1 pr-1 cursor-pointer w-12"
                        >
                            <option value="en">EN</option>
                            <option value="es">ES</option>
                            <option value="hu">HU</option>
                        </select>
                        <button onClick={() => setIsMenuOpen(!isMenuOpen)} className="text-white p-2">
                            {isMenuOpen ? <Icons.Close /> : <Icons.Menu />}
                        </button>
                    </div>
                </div>
            </div>

            {isMenuOpen && (
                 <div className="md:hidden bg-slate-900 border-t border-slate-800 pb-4 px-4">
                    <div className="flex flex-col space-y-2 mt-4">
                         {lightseed && (
                             <button onClick={() => { onProfile(); setIsMenuOpen(false); }} className="flex items-center space-x-3 px-3 py-3 rounded-md bg-slate-800">
                                <img src={lightseed.photoURL || `https://ui-avatars.com/api/?name=${lightseed.displayName}`} className="w-8 h-8 rounded-full" />
                                <span className="text-white font-medium">{t('profile')}</span>
                             </button>
                         )}
                        {['forest', 'pulses', 'visions', 'oracle', 'matches'].map((tabKey) => (
                            <button 
                                key={tabKey}
                                onClick={() => { setTab(tabKey); setIsMenuOpen(false); }}
                                className={`text-left px-3 py-3 rounded-md text-base font-medium ${activeTab === tabKey ? 'bg-slate-800 text-white' : 'text-slate-400'}`}
                            >
                                {tabKey === 'matches' ? 'Matches' : t(tabKey as any)}
                            </button>
                        ))}
                         {lightseed ? (
                            <>
                                <button onClick={() => { onPulse(); setIsMenuOpen(false); }} className={`${colors.earth} text-white px-3 py-3 rounded-md text-base font-medium mt-4 flex items-center`}>
                                    <PulsatingDot />
                                    {t('emit_pulse')}
                                </button>
                                <button onClick={onLogout} className="text-left px-3 py-3 text-slate-400">
                                    {t('sign_out')}
                                </button>
                            </>
                        ) : (
                             <button onClick={() => { onLogin(); setIsMenuOpen(false); }} className="bg-white text-slate-900 px-3 py-3 rounded-md text-base font-bold mt-4">
                                {t('sign_in')}
                            </button>
                        )}
                    </div>
                 </div>
            )}
        </nav>
    );
};

// ... [Existing LightseedProfile, ForestMap, LifetreeCard, VisionCard components remain unchanged] ...
const LightseedProfile = ({ lightseed, myTrees, onViewTree }: any) => {
    const { t } = useLanguage();
    const [activeTab, setActiveTab] = useState<'trees' | 'pulses' | 'visions' | 'history'>('trees');
    const [pulses, setPulses] = useState<Pulse[]>([]);
    const [visions, setVisions] = useState<Vision[]>([]);
    const [history, setHistory] = useState<MatchProposal[]>([]);
    const [loading, setLoading] = useState(false);

    useEffect(() => {
        if (!lightseed) return;
        setLoading(true);
        const fetchData = async () => {
            if (activeTab === 'pulses') {
                const data = await getMyPulses(lightseed.uid);
                setPulses(data);
            } else if (activeTab === 'visions') {
                const data = await getMyVisions(lightseed.uid);
                setVisions(data);
            } else if (activeTab === 'history') {
                const data = await getMyMatchesHistory(lightseed.uid);
                setHistory(data);
            }
            setLoading(false);
        };
        fetchData();
    }, [activeTab, lightseed]);

    if (!lightseed) return null;

    return (
        <div className="min-h-screen bg-slate-50">
            <div className="relative bg-gradient-to-b from-slate-800 to-slate-900 text-white pb-20 pt-10 px-4">
                <div className="max-w-4xl mx-auto flex flex-col md:flex-row items-center md:items-start space-y-6 md:space-y-0 md:space-x-8">
                    <div className="relative">
                        <img 
                            src={lightseed.photoURL || `https://ui-avatars.com/api/?name=${lightseed.displayName}`} 
                            className="w-24 h-24 md:w-32 md:h-32 rounded-full border-4 border-white shadow-xl"
                        />
                        <div className="absolute bottom-1 right-1 bg-emerald-500 w-6 h-6 rounded-full border-4 border-slate-900"></div>
                    </div>
                    <div className="text-center md:text-left">
                        <h1 className="text-3xl font-light tracking-wide">{lightseed.displayName}</h1>
                        <p className="text-slate-400 text-sm font-mono mt-1">{lightseed.email}</p>
                        <div className="flex items-center justify-center md:justify-start space-x-6 mt-6">
                            <div className="text-center">
                                <span className="block text-2xl font-bold">{myTrees.length}</span>
                                <span className="text-xs text-slate-400 uppercase tracking-wider">{t('my_trees')}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div className="max-w-4xl mx-auto px-4 -mt-12">
                <div className="bg-white rounded-xl shadow-lg border border-slate-100 overflow-hidden min-h-[500px]">
                    <div className="flex border-b border-slate-100 overflow-x-auto">
                        <button 
                            onClick={() => setActiveTab('trees')} 
                            className={`flex-1 min-w-[100px] py-4 text-sm font-medium transition-colors ${activeTab === 'trees' ? 'text-emerald-600 border-b-2 border-emerald-500 bg-emerald-50/50' : 'text-slate-500 hover:text-slate-800'}`}
                        >
                            {t('my_trees')}
                        </button>
                        <button 
                            onClick={() => setActiveTab('pulses')} 
                            className={`flex-1 min-w-[100px] py-4 text-sm font-medium transition-colors ${activeTab === 'pulses' ? 'text-sky-600 border-b-2 border-sky-500 bg-sky-50/50' : 'text-slate-500 hover:text-slate-800'}`}
                        >
                            {t('my_pulses')}
                        </button>
                        <button 
                            onClick={() => setActiveTab('visions')} 
                            className={`flex-1 min-w-[100px] py-4 text-sm font-medium transition-colors ${activeTab === 'visions' ? 'text-amber-600 border-b-2 border-amber-500 bg-amber-50/50' : 'text-slate-500 hover:text-slate-800'}`}
                        >
                            {t('visions')}
                        </button>
                        <button 
                            onClick={() => setActiveTab('history')} 
                            className={`flex-1 min-w-[100px] py-4 text-sm font-medium transition-colors ${activeTab === 'history' ? 'text-slate-600 border-b-2 border-slate-500 bg-slate-50/50' : 'text-slate-500 hover:text-slate-800'}`}
                        >
                            {t('my_matches')}
                        </button>
                    </div>

                    <div className="p-6">
                        {activeTab === 'trees' && (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {myTrees.length === 0 ? (
                                    <p className="text-slate-400 text-center py-10">No trees planted yet.</p>
                                ) : (
                                    myTrees.map((tree: Lifetree) => (
                                        <div key={tree.id} onClick={() => onViewTree(tree)} className="border border-slate-200 rounded-lg p-4 hover:shadow-md cursor-pointer transition-all flex items-center space-x-4">
                                            <img src={tree.imageUrl || 'https://via.placeholder.com/100'} className="w-16 h-16 rounded object-cover bg-slate-100" />
                                            <div>
                                                <h3 className="font-bold text-slate-800">{tree.name}</h3>
                                                <p className="text-xs text-slate-500">Block Height: {tree.blockHeight}</p>
                                                {tree.validated ? (
                                                    <span className="text-[10px] bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded-full font-bold">VALIDATED</span>
                                                ) : (
                                                    <span className="text-[10px] bg-slate-100 text-slate-500 px-2 py-0.5 rounded-full">Pending</span>
                                                )}
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        )}
                        {activeTab === 'pulses' && (
                            loading ? <p className="text-center py-10 text-slate-400">Loading...</p> : (
                                <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                    {pulses.length === 0 ? <p className="col-span-full text-slate-400 text-center py-10">No pulses emitted yet.</p> : pulses.map((pulse) => (
                                        <div key={pulse.id} className="border border-slate-100 rounded-lg overflow-hidden group">
                                            <div className="h-24 bg-slate-100 relative">
                                                {pulse.imageUrl ? (
                                                    <img src={pulse.imageUrl} className="w-full h-full object-cover" />
                                                ) : (
                                                    <div className="w-full h-full flex items-center justify-center text-slate-300"><Icons.Hash /></div>
                                                )}
                                            </div>
                                            <div className="p-3">
                                                <h4 className="font-bold text-sm text-slate-800 line-clamp-1">{pulse.title}</h4>
                                                <div className="mt-1 flex items-center space-x-3 text-[10px] text-slate-400">
                                                    <span>{pulse.loveCount} Loves</span>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )
                        )}
                         {activeTab === 'visions' && (
                             loading ? <p className="text-center py-10 text-slate-400">Loading...</p> : (
                                <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                    {visions.length === 0 ? <p className="col-span-full text-slate-400 text-center py-10">No visions created yet.</p> : visions.map((vision) => (
                                        <VisionCard key={vision.id} vision={vision} />
                                    ))}
                                </div>
                             )
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
};
// ... [Existing ForestMap, LifetreeCard, VisionCard components remain the same] ...
const ForestMap = ({ trees }: { trees: Lifetree[] }) => {
    const mapContainer = useRef<HTMLDivElement>(null);
    const mapInstance = useRef<any>(null);
    const markersLayer = useRef<any>(null);

    useEffect(() => {
        if (!mapContainer.current) return;
        const L = (window as any).L;
        if (!L) return;

        // Initialize Map
        if (!mapInstance.current) {
            mapInstance.current = L.map(mapContainer.current, {
                zoomControl: false,
                attributionControl: false
            }).setView([20, 0], 2);
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap & CartoDB',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(mapInstance.current);

            // Add zoom control to bottom right
            L.control.zoom({ position: 'bottomright' }).addTo(mapInstance.current);

            markersLayer.current = L.layerGroup().addTo(mapInstance.current);
            
            // Force a resize check after mount to prevent gray tiles
            setTimeout(() => {
                mapInstance.current?.invalidateSize();
            }, 100);
        }

        // Update Markers
        if (markersLayer.current) {
            markersLayer.current.clearLayers();
            
            const bounds = L.latLngBounds([]);
            let hasMarkers = false;

            trees.forEach(tree => {
                if (tree.latitude && tree.longitude) {
                    hasMarkers = true;
                    bounds.extend([tree.latitude, tree.longitude]);
                    
                    const iconHtml = `
                        <div class="relative w-12 h-12 hover:scale-110 transition-transform duration-300">
                            <div class="absolute inset-0 bg-emerald-500 rounded-full animate-ping opacity-20"></div>
                            <div class="relative w-12 h-12 rounded-full border-2 border-white shadow-xl overflow-hidden bg-white">
                                <img src="${tree.imageUrl || 'https://via.placeholder.com/150'}" class="w-full h-full object-cover" />
                            </div>
                            ${tree.validated ? '<div class="absolute -top-1 -right-1 bg-emerald-500 border border-white w-4 h-4 rounded-full flex items-center justify-center"><div class="w-2 h-2 bg-white rounded-full"></div></div>' : ''}
                        </div>
                    `;
                    
                    const customIcon = L.divIcon({
                        html: iconHtml,
                        className: '',
                        iconSize: [48, 48],
                        iconAnchor: [24, 24],
                        popupAnchor: [0, -24]
                    });

                    L.marker([tree.latitude, tree.longitude], { icon: customIcon })
                        .addTo(markersLayer.current)
                        .bindPopup(`
                            <div class="text-center p-2 min-w-[150px]">
                                <h3 class="font-bold text-lg text-slate-800 mb-1">${tree.name}</h3>
                                <p class="text-xs text-slate-500 line-clamp-2 italic mb-2">"${tree.body}"</p>
                                <div class="text-[10px] font-mono text-emerald-600 bg-emerald-50 px-2 py-1 rounded-full inline-block">Block: ${tree.blockHeight || 0}</div>
                            </div>
                        `);
                }
            });

            // Auto-fit bounds if we have trees
            if (hasMarkers && mapInstance.current) {
                mapInstance.current.fitBounds(bounds, { 
                    padding: [50, 50], 
                    maxZoom: 14,
                    animate: true 
                });
            }
        }

        // Cleanup on unmount
        return () => {
            if (mapInstance.current) {
                mapInstance.current.remove();
                mapInstance.current = null;
                markersLayer.current = null;
            }
        };
    }, [trees]); // Re-run if tree data changes

    return <div ref={mapContainer} className="w-full h-[600px] rounded-xl shadow-inner border border-slate-200 z-0 bg-slate-100" />;
};

const LifetreeCard = ({ tree, myActiveTree, onValidate, onPlayGrowth, onQuickSnap, onView }: any) => {
    // ... Existing LifetreeCard implementation
    const { t } = useLanguage();
    const fileInputRef = useRef<HTMLInputElement>(null);
    const [uploading, setUploading] = useState(false);

    const handleFileChange = async (e: ChangeEvent<HTMLInputElement>) => {
        if (e.target.files && e.target.files[0]) {
            setUploading(true);
            await onQuickSnap(tree.id, e.target.files[0]);
            setUploading(false);
            if(fileInputRef.current) fileInputRef.current.value = "";
        }
    }

    const triggerUpload = (e: React.MouseEvent) => {
        e.stopPropagation();
        fileInputRef.current?.click();
    }
    
    return (
        <div 
            onClick={() => onView(tree)}
            className={`bg-white rounded-xl overflow-hidden shadow-sm border border-slate-200 hover:shadow-lg transition-all duration-300 group relative cursor-pointer ${tree.validated ? 'ring-1 ring-emerald-100' : ''}`}
        >
             <div className="absolute top-2 right-2 z-20 flex space-x-2">
                {tree.validated && (
                    <span className="bg-emerald-100 text-emerald-800 text-[10px] px-2 py-0.5 rounded-full font-bold flex items-center shadow-sm">
                        <Icons.ShieldCheck />
                        <span className="ml-1 text-[9px]">{t('validated')}</span>
                    </span>
                )}
            </div>

            {/* Quick Snap */}
             {myActiveTree && myActiveTree.id === tree.id && (
                 <div className="absolute top-2 left-2 z-20">
                     <button 
                        onClick={triggerUpload} 
                        disabled={uploading}
                        className="flex items-center space-x-1.5 bg-white/95 text-slate-800 px-2.5 py-1 rounded-full shadow-md hover:bg-white hover:text-emerald-700 transition-all active:scale-95"
                    >
                        {uploading ? <div className="w-3 h-3 border-2 border-emerald-500 border-t-transparent rounded-full animate-spin"></div> : <Icons.Camera />}
                        <span className="text-[10px] font-bold uppercase tracking-wider">{t('quick_snap')}</span>
                    </button>
                    <input 
                        type="file" 
                        ref={fileInputRef} 
                        className="hidden" 
                        accept="image/*" 
                        capture="environment" 
                        onChange={handleFileChange} 
                        onClick={(e) => e.stopPropagation()}
                    />
                 </div>
            )}

            <div className="relative h-36 bg-slate-200 overflow-hidden group">
                {tree.imageUrl ? (
                    <img src={tree.imageUrl} alt={tree.name} className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-[3s] animate-[pulse_4s_ease-in-out_infinite]" />
                ) : (
                    <div className={`w-full h-full ${colors.sky} flex items-center justify-center`}>
                        <Logo width={50} height={50} className="opacity-20 text-white animate-pulse" />
                    </div>
                )}

                <div className="absolute inset-0 bg-gradient-to-t from-slate-900/80 to-transparent pointer-events-none"></div>
                <div className="absolute bottom-2 left-3 right-3 text-white pointer-events-none">
                    <h3 className="text-lg font-light tracking-wide truncate">{tree.name}</h3>
                    <div className="flex items-center text-xs text-slate-300 mt-0.5 space-x-2 rtl:space-x-reverse">
                         <span className="px-1.5 py-0 border border-slate-500 rounded-full text-[9px] bg-slate-800/50 backdrop-blur">
                            Block: {tree.blockHeight || 0}
                        </span>
                    </div>
                </div>
            </div>
            <div className="p-3">
                <p className="text-slate-600 text-xs font-light italic leading-relaxed line-clamp-2 h-8">
                    "{tree.body}"
                </p>
                <div className="mt-3 pt-2 border-t border-slate-100 flex justify-between items-center">
                    <button onClick={(e) => { e.stopPropagation(); onPlayGrowth(tree.id); }} className="flex items-center space-x-1 text-[10px] bg-slate-50 hover:bg-slate-100 text-slate-500 px-2 py-1 rounded transition-colors uppercase tracking-wider font-semibold">
                        <Icons.Play />
                        <span>Growth</span>
                    </button>
                    
                    <div className="flex space-x-2">
                        {myActiveTree && myActiveTree.validated && !tree.validated && myActiveTree.id !== tree.id && (
                            <button onClick={(e) => { e.stopPropagation(); onValidate(tree.id); }} className="text-[10px] bg-emerald-50 text-emerald-600 px-2 py-1 rounded hover:bg-emerald-100 transition-colors uppercase font-bold">
                                {t('validate_action')}
                            </button>
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
};

const VisionCard = ({ vision }: { vision: Vision }) => {
    return (
        <div className="bg-white rounded-xl shadow-sm border border-amber-100 overflow-hidden hover:shadow-lg transition-all duration-300 group">
            <div className="relative h-48 bg-amber-50 overflow-hidden">
                {vision.imageUrl ? (
                    <img src={vision.imageUrl} alt={vision.title} className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-700" />
                ) : (
                    <div className="w-full h-full flex items-center justify-center text-amber-300">
                        <Icons.Sparkles />
                    </div>
                )}
                {vision.link && (
                    <a href={vision.link} target="_blank" rel="noopener noreferrer" className="absolute top-2 right-2 bg-white/90 p-2 rounded-full text-amber-600 hover:text-amber-800 hover:scale-110 transition-all shadow-sm">
                        <Icons.Globe />
                    </a>
                )}
            </div>
            <div className="p-5">
                <h3 className="text-lg font-bold text-slate-800 mb-2">{vision.title}</h3>
                <p className="text-slate-600 text-sm font-light leading-relaxed line-clamp-3">
                    {vision.body}
                </p>
            </div>
        </div>
    );
}

const LifetreeDetail = ({ tree, onClose, onPlayGrowth, onValidate, myActiveTree }: any) => {
   // ... Existing detail logic
   const { t } = useLanguage();
    
    return (
        <div className="min-h-screen bg-slate-50 animate-in fade-in zoom-in-95 duration-300">
            {/* Header */}
            <div className="sticky top-0 z-30 bg-white/80 backdrop-blur-md border-b border-slate-200 px-4 py-4 flex items-center justify-between">
                <button onClick={onClose} className="flex items-center space-x-2 text-slate-600 hover:text-slate-900 font-medium">
                    <Icons.ArrowLeft />
                    <span>{t('back_forest')}</span>
                </button>
                <h2 className="text-xl font-light tracking-wide">{tree.name}</h2>
                <div className="w-8"></div> {/* Spacer for center alignment */}
            </div>

            <div className="max-w-4xl mx-auto p-6 space-y-8">
                {/* Hero */}
                <div className="relative h-64 md:h-96 w-full rounded-2xl overflow-hidden shadow-xl">
                    <img 
                        src={tree.imageUrl || 'https://via.placeholder.com/800x400'} 
                        className="w-full h-full object-cover" 
                        alt={tree.name}
                    />
                    <div className="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
                    <div className="absolute bottom-6 left-6 text-white">
                        <div className="flex items-center space-x-3 mb-2">
                            {tree.validated && (
                                <span className="bg-emerald-500 text-white text-xs px-2 py-0.5 rounded-full font-bold flex items-center">
                                    <Icons.ShieldCheck />
                                    <span className="ml-1">{t('validated')}</span>
                                </span>
                            )}
                            <button onClick={() => onPlayGrowth(tree.id)} className="bg-white/20 hover:bg-white/30 text-white text-xs px-3 py-1 rounded-full flex items-center space-x-1 backdrop-blur-sm transition-colors">
                                <Icons.Play />
                                <span>PLAY GROWTH</span>
                            </button>
                        </div>
                        <h1 className="text-4xl md:text-5xl font-thin tracking-tight">{tree.name}</h1>
                    </div>
                </div>

                {/* Info Grid */}
                <div className="grid md:grid-cols-2 gap-8">
                    
                    {/* Left: Bio & Meta */}
                    <div className="space-y-6">
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                            <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4 flex items-center">
                                <Icons.FingerPrint />
                                <span className="ml-2">{t('vision')}</span>
                            </h3>
                            <p className="text-lg font-serif italic text-slate-700 leading-relaxed">
                                "{tree.body}"
                            </p>
                        </div>

                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 space-y-4">
                            <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider mb-2">{t('tree_details')}</h3>
                            
                            <div className="flex justify-between py-2 border-b border-slate-50">
                                <span className="text-slate-500 text-sm">{t('steward')}</span>
                                <span className="text-slate-800 font-mono text-sm">{tree.ownerId.substring(0, 10)}...</span>
                            </div>
                            <div className="flex justify-between py-2 border-b border-slate-50">
                                <span className="text-slate-500 text-sm">{t('location')}</span>
                                <span className="text-slate-800 font-mono text-sm">{tree.locationName}</span>
                            </div>
                            <div className="flex justify-between py-2 border-b border-slate-50">
                                <span className="text-slate-500 text-sm">Lat / Lng</span>
                                <span className="text-slate-800 font-mono text-sm">{tree.latitude?.toFixed(4)}, {tree.longitude?.toFixed(4)}</span>
                            </div>
                             <div className="flex justify-between py-2">
                                <span className="text-slate-500 text-sm">Validator</span>
                                <span className="text-slate-800 font-mono text-sm">{tree.validatorId ? tree.validatorId.substring(0, 8) + '...' : t('unvalidated')}</span>
                            </div>
                        </div>
                    </div>

                    {/* Right: Blockchain */}
                    <div className="space-y-6">
                         <div className="bg-slate-900 text-slate-300 p-6 rounded-2xl shadow-inner font-mono text-xs overflow-hidden relative">
                            <div className="absolute top-0 right-0 p-4 opacity-10">
                                <Logo width={100} height={100} />
                            </div>
                            <h3 className="text-emerald-400 font-bold uppercase tracking-wider mb-6 flex items-center">
                                <Icons.Hash />
                                <span className="ml-2">Blockchain Ledger</span>
                            </h3>

                            <div className="space-y-4 relative z-10">
                                <div>
                                    <p className="text-slate-500 mb-1 uppercase text-[10px]">Block Height</p>
                                    <p className="text-2xl text-white">{tree.blockHeight}</p>
                                </div>
                                <div className="break-all">
                                    <p className="text-slate-500 mb-1 uppercase text-[10px]">{t('genesis')}</p>
                                    <p className="text-emerald-500/80">{tree.genesisHash}</p>
                                </div>
                                <div className="break-all">
                                    <p className="text-slate-500 mb-1 uppercase text-[10px]">{t('latest_hash')}</p>
                                    <p className="text-emerald-300">{tree.latestHash}</p>
                                </div>
                            </div>
                        </div>

                        {/* Actions */}
                        {myActiveTree && myActiveTree.validated && !tree.validated && myActiveTree.id !== tree.id && (
                             <button onClick={() => onValidate(tree.id)} className="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-4 rounded-xl font-bold uppercase tracking-widest shadow-lg shadow-emerald-200 transition-all active:scale-95">
                                {t('validate_action')}
                            </button>
                        )}
                    </div>
                </div>
            </div>
        </div>
    )
};

const GrowthPlayerModal = ({ treeId, onClose }: { treeId: string, onClose: () => void }) => {
    const [images, setImages] = useState<Pulse[]>([]);
    const [index, setIndex] = useState(0);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState('');

    useEffect(() => {
        // Set a timeout to avoid infinite loading if promise hangs
        const timeout = setTimeout(() => {
            if (loading) {
                setLoading(false);
                if (images.length === 0) setError("Request timed out. Check connection.");
            }
        }, 10000);

        fetchGrowthPulses(treeId)
            .then(data => {
                setImages(data.filter(p => p.imageUrl));
                setLoading(false);
            })
            .catch(err => {
                console.error(err);
                setError("Failed to load growth images.");
                setLoading(false);
            });
            
        return () => clearTimeout(timeout);
    }, [treeId]);

    useEffect(() => {
        if (images.length > 1) {
            const timer = setInterval(() => setIndex(i => (i + 1) % images.length), 1000);
            return () => clearInterval(timer);
        }
    }, [images]);

    return (
        <Modal title="Growth Evolution" onClose={onClose}>
            {loading ? <div className="p-10 text-center">Loading Growth...</div> : (
                error ? <div className="p-10 text-center text-red-500">{error}</div> :
                images.length === 0 ? <div className="p-10 text-center">No growth pictures recorded yet.</div> :
                <div className="flex flex-col items-center">
                    <img src={images[index].imageUrl} className="w-full h-64 object-cover rounded-lg shadow-lg mb-4" />
                    <p className="text-center font-bold">{images[index].title}</p>
                    <p className="text-xs text-slate-500">{new Date(images[index].createdAt?.toMillis()).toLocaleDateString()}</p>
                    <div className="mt-4 flex gap-1">
                        {images.map((_, i) => <div key={i} className={`h-1 w-4 rounded ${i === index ? 'bg-emerald-500' : 'bg-slate-200'}`} />)}
                    </div>
                </div>
            )}
        </Modal>
    );
};

const PulseCard = ({ pulse, lightseed, onMatch }: any) => {
    // ... Existing PulseCard
     const { t } = useLanguage();
    const [loved, setLoved] = useState(false);
    const [count, setCount] = useState(pulse.loveCount);

    useEffect(() => {
        if (lightseed) isPulseLoved(pulse.id, lightseed.uid).then(setLoved);
    }, [pulse, lightseed]);

    const handleLove = async () => {
        if (!lightseed) return;
        const newStatus = !loved;
        setLoved(newStatus);
        setCount(c => newStatus ? c + 1 : c - 1);
        await lovePulse(pulse.id, lightseed.uid);
    }

    // New Compact Pulse Card Design (Matches LifetreeCard)
    return (
        <div className={`bg-white rounded-xl overflow-hidden shadow-sm border border-slate-200 hover:shadow-lg transition-all duration-300 group ${pulse.type === 'GROWTH' ? 'ring-2 ring-emerald-500 ring-opacity-20' : ''}`}>
             <div className="relative h-36 bg-slate-100 overflow-hidden group">
                 <div className="absolute top-2 right-2 z-20 flex space-x-1">
                    {pulse.type === 'GROWTH' && <span className="bg-emerald-100 text-emerald-600 text-[9px] px-2 py-0.5 rounded-full font-bold shadow-sm">GROWTH</span>}
                    {pulse.isMatch && <span className="bg-sky-100 text-sky-600 text-[9px] px-2 py-0.5 rounded-full font-bold shadow-sm">MATCH</span>}
                 </div>

                {pulse.imageUrl ? (
                    <img src={pulse.imageUrl} alt={pulse.title} className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" />
                ) : (
                    <div className="w-full h-full flex items-center justify-center text-slate-300 bg-slate-50">
                        <Icons.Hash />
                    </div>
                )}
                
                <div className="absolute inset-0 bg-gradient-to-t from-slate-900/60 to-transparent pointer-events-none"></div>
                <div className="absolute bottom-2 left-3 right-3 text-white pointer-events-none">
                     <h3 className="text-sm font-bold tracking-wide truncate">{pulse.title}</h3>
                </div>
            </div>

            <div className="p-3">
                <p className="text-slate-600 text-xs font-light leading-relaxed line-clamp-2 h-8">
                    {pulse.body}
                </p>
                <div className="mt-3 pt-2 border-t border-slate-100 flex justify-between items-center">
                    <button onClick={handleLove} disabled={!lightseed} className="flex items-center space-x-1 text-slate-500 hover:text-red-500 transition-colors">
                        <Icons.Heart filled={loved} />
                        <span className="text-xs">{count}</span>
                    </button>

                    {lightseed && lightseed.uid !== pulse.authorId && !pulse.isMatch && (
                        <button onClick={() => onMatch(pulse)} className="text-[10px] bg-slate-50 text-slate-500 hover:bg-sky-50 hover:text-sky-600 px-2 py-1 rounded transition-colors flex items-center space-x-1">
                            <Icons.Link /> <span>Match</span>
                        </button>
                    )}
                </div>
            </div>
        </div>
    );
};

// ... Modals (ImagePicker, etc) ... 
const Modal = ({ children, onClose, title }: any) => (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm">
        <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden animate-in fade-in zoom-in-95">
            <div className="bg-slate-50 px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                <h3 className="font-semibold text-slate-800">{title}</h3>
                <button onClick={onClose} className="text-slate-400 hover:text-slate-600">&times;</button>
            </div>
            <div className="p-6 max-h-[80vh] overflow-y-auto">{children}</div>
        </div>
    </div>
);
const ImagePicker = ({ onChange, previewUrl, loading }: any) => {
    const fileInput = useRef<HTMLInputElement>(null);
    return (
        <div className="space-y-2">
             <div onClick={() => fileInput.current?.click()} className={`border-2 border-dashed border-slate-300 rounded-xl p-4 flex flex-col items-center justify-center cursor-pointer hover:border-emerald-500 hover:bg-slate-50 transition-colors h-40 ${previewUrl ? 'border-none p-0' : ''}`}>
                <input type="file" ref={fileInput} className="hidden" accept="image/*" onChange={onChange} />
                {loading ? <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-500"></div> : previewUrl ? <img src={previewUrl} className="w-full h-full object-cover rounded-xl" /> : <div className="text-center text-slate-400"><Icons.Camera /><span className="text-xs mt-2 block">Upload Photo</span></div>}
             </div>
        </div>
    );
};

// --- ORACLE CHAT ---
const OracleChat = () => {
    const { t } = useLanguage();
    const [messages, setMessages] = useState<{role: 'user' | 'model', text: string}[]>([]);
    const [input, setInput] = useState('');
    const [chat, setChat] = useState<Chat | null>(null);
    const [isTyping, setIsTyping] = useState(false);
    const bottomRef = useRef<HTMLDivElement>(null);

    useEffect(() => {
        try {
            const c = createOracleChat();
            setChat(c);
            setMessages([{role: 'model', text: "I am the LifeSeed Oracle. Ask me of roots, seeds, and the digital winds..."}]);
        } catch(e) {
            setMessages([{role: 'model', text: "The connection to the spirits (API) is severed. Please check your Key."}]);
        }
    }, []);

    useEffect(() => {
        bottomRef.current?.scrollIntoView({ behavior: 'smooth' });
    }, [messages]);

    const handleSend = async (e: React.FormEvent) => {
        e.preventDefault();
        if (!input.trim() || !chat) return;

        const userMsg = input;
        setInput('');
        setMessages(prev => [...prev, {role: 'user', text: userMsg}]);
        setIsTyping(true);

        try {
            const response: GenerateContentResponse = await chat.sendMessage({ message: userMsg });
            setMessages(prev => [...prev, {role: 'model', text: response.text || "..."}]);
        } catch(e) {
            setMessages(prev => [...prev, {role: 'model', text: "The wind is too strong (Error connecting to AI)."}]);
        }
        setIsTyping(false);
    }

    return (
        <div className="max-w-2xl mx-auto h-[70vh] flex flex-col bg-white rounded-xl shadow-lg border border-indigo-100 overflow-hidden">
            <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50">
                {messages.map((m, i) => (
                    <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                        <div className={`max-w-[80%] rounded-2xl px-4 py-3 text-sm ${
                            m.role === 'user' 
                                ? 'bg-indigo-600 text-white rounded-br-none' 
                                : 'bg-white border border-slate-200 text-slate-700 rounded-bl-none shadow-sm'
                        }`}>
                            {m.text}
                        </div>
                    </div>
                ))}
                {isTyping && (
                    <div className="flex justify-start">
                        <div className="bg-white border border-slate-200 rounded-2xl rounded-bl-none px-4 py-3 shadow-sm">
                            <div className="flex space-x-1">
                                <div className="w-2 h-2 bg-slate-400 rounded-full animate-bounce"></div>
                                <div className="w-2 h-2 bg-slate-400 rounded-full animate-bounce delay-75"></div>
                                <div className="w-2 h-2 bg-slate-400 rounded-full animate-bounce delay-150"></div>
                            </div>
                        </div>
                    </div>
                )}
                <div ref={bottomRef}></div>
            </div>
            <form onSubmit={handleSend} className="p-4 bg-white border-t border-slate-100 flex space-x-2">
                <input 
                    value={input}
                    onChange={e => setInput(e.target.value)}
                    placeholder="Ask the Oracle..."
                    className="flex-1 border border-slate-200 rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                />
                <button type="submit" disabled={isTyping || !input.trim()} className="bg-indigo-600 text-white p-2 rounded-full hover:bg-indigo-700 disabled:opacity-50 transition-colors">
                    <Icons.Send />
                </button>
            </form>
        </div>
    )
}

const AppContent = () => {
    const { t } = useLanguage();
    const { lightseed, myTrees, activeTree, loading: authLoading, refreshTrees } = useLifeseed();
    const [tab, setTab] = useState('forest');
    const [viewMode, setViewMode] = useState<'grid' | 'map'>('grid');
    const [data, setData] = useState<any[]>([]);
    const [matches, setMatches] = useState<MatchProposal[]>([]);
    const [selectedTree, setSelectedTree] = useState<Lifetree | null>(null);
    const [searchTerm, setSearchTerm] = useState('');
    
    // UI State
    const [showPlantModal, setShowPlantModal] = useState(false);
    const [showPulseModal, setShowPulseModal] = useState(false);
    const [showVisionModal, setShowVisionModal] = useState(false);
    const [showGrowthPlayer, setShowGrowthPlayer] = useState<string | null>(null);
    const [matchCandidate, setMatchCandidate] = useState<Pulse | null>(null);

    // Form State
    const [treeName, setTreeName] = useState('');
    const [treeSeed, setTreeSeed] = useState('');
    const [treeBio, setTreeBio] = useState('');
    const [treeImageUrl, setTreeImageUrl] = useState('');
    
    const [pulseTitle, setPulseTitle] = useState('');
    const [pulseBody, setPulseBody] = useState('');
    const [pulseImageUrl, setPulseImageUrl] = useState('');
    const [isGrowth, setIsGrowth] = useState(false);
    const [uploading, setUploading] = useState(false);
    
    // Vision Form State
    const [visionTitle, setVisionTitle] = useState('');
    const [visionBody, setVisionBody] = useState('');
    const [visionLink, setVisionLink] = useState('');
    const [visionImageUrl, setVisionImageUrl] = useState('');

    useEffect(() => { loadContent(); }, [tab, lightseed]);
    useEffect(() => { if (lightseed && myTrees.length === 0 && !authLoading) setShowPlantModal(true); }, [lightseed, myTrees]);

    const loadContent = async () => {
        setData([]); // Clear data before loading
        if (tab === 'forest') setData(await fetchLifetrees());
        else if (tab === 'pulses') setData(await fetchPulses());
        else if (tab === 'visions') setData(await fetchVisions());
        else if (tab === 'matches' && lightseed) setMatches(await getPendingMatches(lightseed.uid));
    };

    const handleImageUpload = async (file: File, path: string) => {
        setUploading(true);
        const url = await uploadImage(file, path);
        setUploading(false);
        return url;
    };
    
    const handleGenerateVisionImage = async () => {
        if (!visionBody) { alert("Please enter a vision description first."); return; }
        setUploading(true);
        try {
            const url = await generateVisionImage(visionBody);
            if (url) {
                setVisionImageUrl(url);
            } else {
                throw new Error("No image data returned from AI service.");
            }
        } catch (e: any) {
             alert(`Image generation failed: ${e.message}`);
        }
        setUploading(false);
    }

    const handleQuickSnap = async (treeId: string, file: File) => {
        if (!lightseed) return;
        try {
            const url = await handleImageUpload(file, `growth/${treeId}/${Date.now()}`);
            await mintPulse({
                lifetreeId: treeId,
                type: 'GROWTH',
                title: 'Growth Snapshot',
                body: `Snapped on ${new Date().toLocaleDateString()}`,
                imageUrl: url,
                authorId: lightseed.uid,
                authorName: lightseed.displayName || "Soul",
                authorPhoto: lightseed.photoURL || undefined,
            });
            await loadContent(); 
        } catch (e: any) {
            alert("Error taking picture: " + e.message);
        }
    }

    const handlePlant = async (e: FormEvent) => {
        e.preventDefault();
        if (!lightseed) return;
        navigator.geolocation.getCurrentPosition(async (pos) => {
            try {
                await plantLifetree({ ownerId: lightseed.uid, name: treeName, body: treeBio, imageUrl: treeImageUrl, lat: pos.coords.latitude, lng: pos.coords.longitude });
                await refreshTrees(); setShowPlantModal(false); loadContent();
            } catch(e: any) { alert(e.message); }
        });
    };

    const handleEmitPulse = async (e: FormEvent) => {
        e.preventDefault();
        if (!lightseed || !activeTree) return;
        
        let finalImageUrl = pulseImageUrl;
        if (pulseImageUrl.startsWith('data:')) {
             setUploading(true);
             try {
                 finalImageUrl = await uploadBase64Image(pulseImageUrl, `pulses/ai/${Date.now()}`);
             } catch(e) {
                 setUploading(false);
                 alert("Failed to upload AI image");
                 return;
             }
             setUploading(false);
        }

        try {
            await mintPulse({
                lifetreeId: activeTree.id,
                type: isGrowth ? 'GROWTH' : 'STANDARD',
                title: pulseTitle,
                body: pulseBody,
                imageUrl: finalImageUrl,
                authorId: lightseed.uid,
                authorName: lightseed.displayName || "Soul",
                authorPhoto: lightseed.photoURL || undefined,
            });
            setShowPulseModal(false); setPulseTitle(''); setPulseBody(''); setPulseImageUrl(''); setIsGrowth(false); loadContent();
        } catch(e: any) { alert(e.message); }
    };
    
    const handleCreateVision = async (e: FormEvent) => {
        e.preventDefault();
        if (!lightseed || !activeTree) return;

        let finalImageUrl = visionImageUrl;
        if (visionImageUrl.startsWith('data:')) {
             setUploading(true);
             try {
                 finalImageUrl = await uploadBase64Image(visionImageUrl, `visions/ai/${Date.now()}`);
             } catch(e) {
                 setUploading(false);
                 alert("Failed to upload AI image");
                 return;
             }
             setUploading(false);
        }

        try {
            await createVision({
                lifetreeId: activeTree.id,
                authorId: lightseed.uid,
                title: visionTitle,
                body: visionBody,
                link: visionLink,
                imageUrl: finalImageUrl
            });
            setShowVisionModal(false); setVisionTitle(''); setVisionBody(''); setVisionLink(''); setVisionImageUrl(''); loadContent();
        } catch(e:any) { alert(e.message); }
    }
    
    const initiateMatch = async (e: FormEvent) => {
        e.preventDefault();
        if (!lightseed || !activeTree || !matchCandidate) return;
        try {
             await proposeMatch({
                 initiatorPulseId: "PENDING_CREATION",
                 initiatorTreeId: activeTree.id,
                 initiatorUid: lightseed.uid,
                 targetPulseId: matchCandidate.id,
                 targetTreeId: matchCandidate.lifetreeId,
                 targetUid: matchCandidate.authorId
             });
             alert("Match Proposed! Waiting for acceptance.");
             setShowPulseModal(false); setMatchCandidate(null);
        } catch(e:any) { alert(e.message); }
    }

    const onAcceptMatch = async (id: string) => {
        try { await acceptMatch(id); alert("Match Accepted! Blocks synced."); loadContent(); } 
        catch(e:any) { alert(e.message); }
    }

    // Filter Logic for Forest View
    const filteredData = data.filter((item: any) => {
        if (!searchTerm) return true;
        const term = searchTerm.toLowerCase();
        // Common props for searching
        const text = (item.title || item.name || "") + " " + (item.body || "") + " " + (item.locationName || "");
        return text.toLowerCase().includes(term);
    });

    if (authLoading) return <div className="h-screen w-full flex items-center justify-center bg-slate-50"><Logo className="animate-pulse" /></div>;
    
    if (selectedTree) {
        return (
            <div className={`min-h-screen ${colors.snow} font-sans text-slate-800`}>
                <LifetreeDetail 
                    tree={selectedTree} 
                    onClose={() => setSelectedTree(null)} 
                    onPlayGrowth={setShowGrowthPlayer}
                    onValidate={(id: string) => validateLifetree(id, activeTree!.id).then(() => { alert("Validated!"); setSelectedTree(null); loadContent(); })}
                    myActiveTree={activeTree}
                />
                 {showGrowthPlayer && <GrowthPlayerModal treeId={showGrowthPlayer} onClose={() => setShowGrowthPlayer(null)} />}
            </div>
        )
    }

    if (tab === 'profile' && lightseed) {
        return (
            <div className={`min-h-screen ${colors.snow} font-sans text-slate-800`}>
                <Navigation 
                    lightseed={lightseed} 
                    activeTab={tab} 
                    setTab={setTab} 
                    onLogin={signInWithGoogle} 
                    onLogout={logout} 
                    onPlant={() => setShowPlantModal(true)} 
                    onPulse={() => setShowPulseModal(true)}
                    onCreateVision={() => setShowVisionModal(true)}
                    onProfile={() => setTab('profile')} 
                />
                <LightseedProfile 
                    lightseed={lightseed} 
                    myTrees={myTrees} 
                    onViewTree={(tree: Lifetree) => setSelectedTree(tree)}
                />
            </div>
        )
    }

    return (
        <div className={`min-h-screen ${colors.snow} font-sans text-slate-800`}>
            <Navigation 
                lightseed={lightseed} 
                activeTab={tab} 
                setTab={setTab} 
                onLogin={signInWithGoogle} 
                onLogout={logout} 
                onPlant={() => setShowPlantModal(true)} 
                onPulse={() => setShowPulseModal(true)}
                onCreateVision={() => setShowVisionModal(true)}
                onProfile={() => setTab('profile')} 
            />
            
            <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
                {/* Search Bar for all tabs except matches/profile/oracle */}
                {tab !== 'matches' && tab !== 'profile' && tab !== 'oracle' && (
                    <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <div className="relative w-full md:max-w-md">
                            <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">
                                <Icons.Search />
                            </div>
                            <input 
                                type="text"
                                className="block w-full pl-10 pr-3 py-2 border border-slate-200 rounded-lg leading-5 bg-white placeholder-slate-400 focus:outline-none focus:ring-1 focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm shadow-sm"
                                placeholder="Search..."
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                            />
                        </div>

                        {/* View Switcher only for Forest */}
                        {tab === 'forest' && (
                            <div className="bg-white p-1 rounded-lg border border-slate-200 flex shadow-sm shrink-0">
                                <button 
                                    onClick={() => setViewMode('grid')}
                                    className={`px-4 py-2 text-sm font-medium rounded-md transition-all ${viewMode === 'grid' ? 'bg-slate-800 text-white shadow' : 'text-slate-500 hover:text-slate-800'}`}
                                >
                                    <div className="flex items-center space-x-2">
                                        <Icons.List />
                                        <span>{t('list_view')}</span>
                                    </div>
                                </button>
                                <button 
                                    onClick={() => setViewMode('map')}
                                    className={`px-4 py-2 text-sm font-medium rounded-md transition-all ${viewMode === 'map' ? 'bg-slate-800 text-white shadow' : 'text-slate-500 hover:text-slate-800'}`}
                                >
                                    <div className="flex items-center space-x-2">
                                        <Icons.Map />
                                        <span>{t('map_view')}</span>
                                    </div>
                                </button>
                            </div>
                        )}
                    </div>
                )}

                {/* Matches Inbox */}
                {tab === 'matches' && (
                    <div className="max-w-2xl mx-auto">
                        <h2 className="text-2xl font-light mb-6">Pending Matches</h2>
                        {matches.length === 0 ? <p className="text-slate-400">No pending requests.</p> : matches.map(m => (
                            <div key={m.id} className="bg-white p-4 rounded shadow-sm border border-slate-200 mb-4 flex justify-between items-center">
                                <div><p className="font-bold">Match Request</p><p className="text-sm text-slate-500">From another Tree</p></div>
                                <button onClick={() => onAcceptMatch(m.id)} className="bg-sky-500 text-white px-4 py-2 rounded">Accept & Sync</button>
                            </div>
                        ))}
                    </div>
                )}

                {/* Oracle Chat */}
                {tab === 'oracle' && <OracleChat />}

                {/* Content Area */}
                {tab === 'forest' ? (
                    viewMode === 'map' ? (
                        <ForestMap trees={filteredData} />
                    ) : (
                        <div className="grid gap-4 grid-cols-2 md:grid-cols-3 lg:grid-cols-4">
                             {filteredData.length === 0 ? (
                                 <p className="col-span-full text-center text-slate-400 py-10">No trees found matching your search.</p>
                             ) : (
                                filteredData.map((item: any) => (
                                    <LifetreeCard 
                                        key={item.id} 
                                        tree={item} 
                                        myActiveTree={activeTree} 
                                        onPlayGrowth={setShowGrowthPlayer} 
                                        onQuickSnap={handleQuickSnap}
                                        onValidate={(id: string) => validateLifetree(id, activeTree!.id).then(() => { alert("Validated!"); loadContent(); })}
                                        onView={setSelectedTree}
                                    />
                                ))
                             )}
                        </div>
                    )
                ) : tab === 'visions' ? (
                    <div className="grid gap-6 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3">
                        {filteredData.length === 0 ? <p className="col-span-full text-center text-slate-400 py-10">No visions found.</p> : 
                            filteredData.map((item: any) => <VisionCard key={item.id} vision={item} />)
                        }
                    </div>
                ) : tab !== 'matches' && tab !== 'profile' && tab !== 'oracle' && (
                    <div className="grid gap-4 grid-cols-2 md:grid-cols-3 lg:grid-cols-4">
                        {data.map((item) => (
                             <PulseCard key={item.id} pulse={item} lightseed={lightseed} onMatch={(p: Pulse) => { setMatchCandidate(p); setShowPulseModal(true); }} />
                        ))}
                    </div>
                )}
            </main>

            {/* Growth Player Modal */}
            {showGrowthPlayer && <GrowthPlayerModal treeId={showGrowthPlayer} onClose={() => setShowGrowthPlayer(null)} />}

            {/* Plant Modal (Simplified) */}
            {showPlantModal && (
                <Modal title={t('plant_lifetree')} onClose={() => myTrees.length > 0 && setShowPlantModal(false)}>
                    <form onSubmit={handlePlant} className="space-y-4">
                        <ImagePicker onChange={(e: any) => handleImageUpload(e.target.files[0], `trees/${Date.now()}`).then(setTreeImageUrl)} previewUrl={treeImageUrl} loading={uploading} />
                        <input className="block w-full border p-2 rounded" placeholder="Tree Name" value={treeName} onChange={e=>setTreeName(e.target.value)} required />
                        <div className="flex gap-2"><input className="flex-1 border p-2 rounded" placeholder="Seed keywords" value={treeSeed} onChange={e=>setTreeSeed(e.target.value)} /><button type="button" onClick={() => generateLifetreeBio(treeSeed).then(setTreeBio)} className="bg-emerald-600 text-white px-4 rounded">AI</button></div>
                        <textarea className="block w-full border p-2 rounded" placeholder="Vision" value={treeBio} onChange={e=>setTreeBio(e.target.value)} required />
                        <button type="submit" disabled={uploading} className="w-full bg-emerald-600 text-white py-2 rounded">Plant</button>
                    </form>
                </Modal>
            )}

            {/* Vision Creation Modal */}
            {showVisionModal && (
                <Modal title={t('create_vision')} onClose={() => setShowVisionModal(false)}>
                    <form onSubmit={handleCreateVision} className="space-y-4">
                         <div className="border border-slate-200 p-4 rounded-xl text-center space-y-2">
                             {visionImageUrl ? (
                                 <img src={visionImageUrl} className="w-full h-40 object-cover rounded-lg" />
                             ) : (
                                 <div className="text-slate-400 h-40 flex items-center justify-center bg-slate-50 rounded-lg">No Image</div>
                             )}
                             <div className="flex gap-2 justify-center">
                                 <div className="relative overflow-hidden">
                                    <button type="button" className="text-sm text-slate-500 hover:text-slate-800 px-3 py-1 border rounded">{t('upload_photo')}</button>
                                    <input type="file" className="absolute inset-0 opacity-0 cursor-pointer" accept="image/*" onChange={(e) => { if(e.target.files?.[0]) handleImageUpload(e.target.files[0], `visions/${Date.now()}`).then(setVisionImageUrl) }} />
                                 </div>
                                 <button type="button" onClick={handleGenerateVisionImage} disabled={uploading} className="text-sm bg-amber-500 text-white px-3 py-1 rounded hover:bg-amber-600">{t('generate_image')}</button>
                             </div>
                         </div>

                        <input className="block w-full border p-2 rounded" placeholder={t('title')} value={visionTitle} onChange={e=>setVisionTitle(e.target.value)} required />
                        <textarea className="block w-full border p-2 rounded h-24" placeholder={t('body')} value={visionBody} onChange={e=>setVisionBody(e.target.value)} required />
                        <input className="block w-full border p-2 rounded" placeholder={t('webpage')} value={visionLink} onChange={e=>setVisionLink(e.target.value)} />
                        
                        <button type="submit" disabled={uploading} className="w-full bg-amber-500 text-white py-2 rounded font-bold hover:bg-amber-600 transition-colors">{t('create_vision')}</button>
                    </form>
                </Modal>
            )}

            {/* Pulse / Match Modal */}
            {showPulseModal && (
                <Modal title={matchCandidate ? "Propose Match" : t('emit_pulse')} onClose={() => { setShowPulseModal(false); setMatchCandidate(null); }}>
                    <form onSubmit={matchCandidate ? initiateMatch : handleEmitPulse} className="space-y-4">
                        {matchCandidate ? (
                             <div className="bg-sky-50 p-4 rounded text-sky-800">
                                Matching with <strong>{matchCandidate.title}</strong>. 
                                <br/><span className="text-xs">This will send a request to the owner.</span>
                             </div>
                        ) : (
                            <>
                                <ImagePicker onChange={(e: any) => handleImageUpload(e.target.files[0], `pulses/${Date.now()}`).then(setPulseImageUrl)} previewUrl={pulseImageUrl} loading={uploading} />
                                <div className="flex items-center space-x-2">
                                    <input type="checkbox" id="growth" checked={isGrowth} onChange={e => setIsGrowth(e.target.checked)} className="rounded text-emerald-600 focus:ring-emerald-500" />
                                    <label htmlFor="growth" className="text-sm font-medium text-slate-700">This is a Growth Picture (Internal Pulse)</label>
                                </div>
                                <input className="block w-full border p-2 rounded" placeholder="Title" value={pulseTitle} onChange={e=>setPulseTitle(e.target.value)} required />
                                <textarea className="block w-full border p-2 rounded" placeholder="Body" value={pulseBody} onChange={e=>setPulseBody(e.target.value)} required />
                            </>
                        )}
                        <button type="submit" disabled={uploading} className="w-full bg-emerald-600 text-white py-2 rounded">{matchCandidate ? "Send Request" : t('mint')}</button>
                    </form>
                </Modal>
            )}
        </div>
    );
};

const App = () => (<LanguageProvider><AppContent /></LanguageProvider>);
export default App;


=== ./index.html ===
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>lifeseed</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
      body {
        font-family: 'Inter', sans-serif;
      }
    </style>
  <script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.27.0",
    "firebase/": "https://aistudiocdn.com/firebase@^12.6.0/",
    "path": "https://aistudiocdn.com/path@^0.12.7",
    "vite": "https://aistudiocdn.com/vite@^7.2.7",
    "@vitejs/plugin-react": "https://aistudiocdn.com/@vitejs/plugin-react@^5.1.2"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
  <body class="bg-slate-50 text-slate-800">
    <div id="root"></div>
    <script type="module" src="/index.tsx"></script>
  </body>
</html>

=== ./contexts/LanguageContext.tsx ===
import React, { createContext, useContext, useState, ReactNode } from 'react';
import { translations, Language } from '../utils/translations';

interface LanguageContextType {
  language: Language;
  setLanguage: (lang: Language) => void;
  t: (key: keyof typeof translations['en']) => string;
  isRTL: boolean;
}

const LanguageContext = createContext<LanguageContextType | undefined>(undefined);

export const LanguageProvider = ({ children }: { children: ReactNode }) => {
  const [language, setLanguage] = useState<Language>('en');

  const t = (key: keyof typeof translations['en']) => {
    return translations[language][key] || translations['en'][key];
  };

  const isRTL = language === 'ar';

  return (
    <LanguageContext.Provider value={{ language, setLanguage, t, isRTL }}>
      <div dir={isRTL ? 'rtl' : 'ltr'} className={isRTL ? 'font-arabic' : ''}>
        {children}
      </div>
    </LanguageContext.Provider>
  );
};

export const useLanguage = () => {
  const context = useContext(LanguageContext);
  if (!context) throw new Error("useLanguage must be used within a LanguageProvider");
  return context;
};

=== ./metadata.json ===
{
  "name": "lifeseed.online",
  "description": "A decentralized social sharing platform where every lifetree is a blockchain of presents.",
  "requestFramePermissions": [
    "geolocation",
    "camera",
    "microphone"
  ]
}

=== ./cors.json ===
[
  {
    "origin": ["*"],
    "method": ["GET", "POST", "PUT", "DELETE", "HEAD", "OPTIONS"],
    "maxAgeSeconds": 3600
  }
]


=== ./utils/polyfill.ts ===

// This file runs before the app to ensure process.env is set up correctly
declare global {
  interface Window {
    process: any;
  }
  var __STATIC_ENV__: any;
}

if (typeof window !== 'undefined') {
  window.process = window.process || {};
  window.process.env = window.process.env || {};
  
  // __STATIC_ENV__ is replaced by Vite at build time with the contents of .env
  // We use typeof check to prevent reference errors if it wasn't defined for some reason
  const staticEnv = (typeof __STATIC_ENV__ !== 'undefined') ? __STATIC_ENV__ : {};
  
  // runtimeEnv might be injected by the host environment (e.g. AI Studio)
  const runtimeEnv = window.process.env;
  
  // Merge: Static envs form the base, runtime envs override them if present.
  window.process.env = { ...staticEnv, ...runtimeEnv };
}

export {};


=== ./utils/crypto.ts ===
export async function sha256(message: string): Promise<string> {
  const msgBuffer = new TextEncoder().encode(message);
  const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  const hashHex = hashArray.map((b) => b.toString(16).padStart(2, '0')).join('');
  return hashHex;
}

export async function createBlock(
  previousHash: string,
  data: object,
  timestamp: number
): Promise<string> {
  const payload = JSON.stringify(data) + previousHash + timestamp;
  return await sha256(payload);
}

=== ./utils/translations.ts ===



export type Language = 'en' | 'es' | 'hu' | 'qu' | 'sa' | 'ja' | 'ar';

export const translations = {
  en: {
    forest: "Forest",
    pulses: "Pulses",
    visions: "Visions",
    oracle: "Oracle",
    sign_in: "Sign in",
    sign_out: "Sign out",
    emit_pulse: "Emit Pulse",
    plant_lifetree: "Plant Lifetree",
    create_vision: "New Vision",
    connect_roots: "We need your roots (location) to plant a tree.",
    tree_name: "Tree Name",
    vision: "Vision (The Body)",
    title: "Title",
    body: "Body",
    webpage: "Webpage Link",
    mint: "Mint Pulse (NFT)",
    generate: "Generate",
    generate_image: "Generate with Nano Banana",
    ai_prompt: "Use AI to generate your Vision",
    dormant: "The soil is dormant here.",
    latest_hash: "Latest Hash",
    prev: "PREV",
    block: "BLOCK",
    loading: "Loading...",
    login_failed: "Login failed",
    geo_error: "Geolocation error",
    planting: "Planting...",
    minting: "Pulsing...",
    creating: "Creating...",
    map_view: "Map View",
    list_view: "List View",
    upload_photo: "Upload Photo",
    validated: "VALIDATED",
    unvalidated: "Unvalidated",
    validate_action: "Validate this Tree",
    cant_plant: "You must validate your existing tree before planting another.",
    match_pulse: "Match / Send to another Tree?",
    quick_snap: "Quick Snap",
    back_forest: "Back to Forest",
    genesis: "Genesis Hash",
    steward: "Steward",
    location: "Location",
    tree_details: "Tree Details",
    profile: "Profile",
    my_trees: "My Trees",
    my_pulses: "My Pulses",
    my_matches: "My Matches",
    joined: "Joined",
    total_love: "Total Love"
  },
  es: {
    forest: "Bosque",
    pulses: "Pulsos",
    visions: "Visiones",
    oracle: "Orculo",
    sign_in: "Iniciar sesin",
    sign_out: "Cerrar sesin",
    emit_pulse: "Emitir Pulso",
    plant_lifetree: "Plantar rbol de Vida",
    create_vision: "Nueva Visin",
    connect_roots: "Necesitamos tus races (ubicacin) para plantar.",
    tree_name: "Nombre del rbol",
    vision: "Visin (El Cuerpo)",
    title: "Ttulo",
    body: "Cuerpo",
    webpage: "Enlace Web",
    mint: "Acuar Pulso",
    generate: "Generar",
    generate_image: "Generar con Nano Banana",
    ai_prompt: "Usa IA para generar tu Visin",
    dormant: "El suelo duerme aqu.",
    latest_hash: "ltimo Hash",
    prev: "ANT",
    block: "BLOQUE",
    loading: "Cargando...",
    login_failed: "Error de inicio de sesin",
    geo_error: "Error de geolocalizacin",
    planting: "Plantando...",
    minting: "Pulsando...",
    creating: "Creando...",
    map_view: "Vista de Mapa",
    list_view: "Vista de Lista",
    upload_photo: "Subir Foto",
    validated: "VALIDADO",
    unvalidated: "No validado",
    validate_action: "Validar este rbol",
    cant_plant: "Debes validar tu rbol existente antes de plantar otro.",
    match_pulse: "Coincidir / Enviar a otro rbol?",
    quick_snap: "Foto Rpida",
    back_forest: "Volver al Bosque",
    genesis: "Hash Gnesis",
    steward: "Guardin",
    location: "Ubicacin",
    tree_details: "Detalles del rbol",
    profile: "Perfil",
    my_trees: "Mis rboles",
    my_pulses: "Mis Pulsos",
    my_matches: "Mis Coincidencias",
    joined: "Se uni",
    total_love: "Amor Total"
  },
  hu: {
    forest: "Erd",
    pulses: "Pulzusok",
    visions: "Vzik",
    oracle: "Orkulum",
    sign_in: "Bejelentkezs",
    sign_out: "Kijelentkezs",
    emit_pulse: "Pulzus Kibocstsa",
    plant_lifetree: "letfa ltetse",
    create_vision: "j Vzi",
    connect_roots: "Szksgnk van a gykereire (helyzetre) az ltetshez.",
    tree_name: "Fa Neve",
    vision: "Jvkp (A Test)",
    title: "Cm",
    body: "Szveg",
    webpage: "Weboldal Link",
    mint: "Pulzus Verse",
    generate: "Generls",
    generate_image: "Kp Generlsa (Nano Banana)",
    ai_prompt: "AI hasznlata a jvkphez",
    dormant: "Itt alszik a fld.",
    latest_hash: "Legutbbi Hash",
    prev: "ELZ",
    block: "BLOKK",
    loading: "Betlts...",
    login_failed: "Sikertelen bejelentkezs",
    geo_error: "Helymeghatrozsi hiba",
    planting: "ltets...",
    minting: "Pulzls...",
    creating: "Ltrehozs...",
    map_view: "Trkp Nzet",
    list_view: "Lista Nzet",
    upload_photo: "Fnykp Feltltse",
    validated: "HITELESTVE",
    unvalidated: "Nem hitelestett",
    validate_action: "Fa Hitelestse",
    cant_plant: "A kvetkez ltetse eltt hitelestenie kell a meglv fjt.",
    match_pulse: "Prosts / Klds msik Fhoz?",
    quick_snap: "Gyors Fot",
    back_forest: "Vissza az Erdbe",
    genesis: "Genezis Hash",
    steward: "Gondnok",
    location: "Helyszn",
    tree_details: "Fa Rszletei",
    profile: "Profil",
    my_trees: "Fim",
    my_pulses: "Pulzusaim",
    my_matches: "Prostsaim",
    joined: "Csatlakozott",
    total_love: "sszes Szeretet"
  },
  qu: { 
    forest: "Sach'a-sach'a",
    pulses: "Sirkaykuna",
    visions: "Musquykuna",
    oracle: "Willaq",
    sign_in: "Yaykuy",
    sign_out: "Lloqsiy",
    emit_pulse: "Sirkayta Kachay",
    plant_lifetree: "Kawsay Mallkita Tarpuy",
    create_vision: "Musuq Musquy",
    connect_roots: "Saphikiykita (tiyayniykita) necesitayku.",
    tree_name: "Mallki Suti",
    vision: "Rikuy (Ukhu)",
    title: "Suti",
    body: "Kurku",
    webpage: "Llikachay T'inki",
    mint: "Sirkayta Paqarichiy",
    generate: "Paqarichiy",
    generate_image: "Ruray Nano Banana-wan",
    ai_prompt: "AI-wan visionniykita ruray",
    dormant: "Allpaqa puuchkanmi.",
    latest_hash: "Qhipa Hash",
    prev: "AWPAQ",
    block: "TAQE",
    loading: "Cargachkan...",
    login_failed: "Mana yaykuyta atikunchu",
    geo_error: "Tiyay pantay",
    planting: "Tarpuchkan...",
    minting: "Sirkaychkan...",
    creating: "Rurachkan...",
    map_view: "Mapa Rikuy",
    list_view: "Sutisuyu Rikuy",
    upload_photo: "Fotota Churay",
    validated: "CHASKISQA",
    unvalidated: "Mana chaskisqa",
    validate_action: "Kay Mallkita Chaskiy",
    cant_plant: "awpaq mallkiyki chaskisqa kanan tiyan.",
    match_pulse: "Tupachiy / Huk Mallkiman Kachay?",
    quick_snap: "Utqaylla Foto",
    back_forest: "Sach'a-sach'aman Kutiy",
    genesis: "Qallariy Hash",
    steward: "Kamayoq",
    location: "Tiyay",
    tree_details: "Mallki Willakuykuna",
    profile: "Runaq Uyan",
    my_trees: "Mallkiykuna",
    my_pulses: "Sirkaykuna",
    my_matches: "Tupachisqaykuna",
    joined: "Yaykurqa",
    total_love: "Tukuy Munakuynin"
  },
  sa: { 
    forest: " (Arayam)",
    pulses: " (Spandanni)",
    visions: " (Daya)",
    oracle: " (Daivav)",
    sign_in: " (Praviatu)",
    sign_out: " (Nirgacchatu)",
    emit_pulse: " ",
    plant_lifetree: " ",
    create_vision: " ",
    connect_roots: "   ",
    tree_name: "",
    vision: "",
    title: "",
    body: "",
    webpage: " ",
    mint: " ",
    generate: "",
    generate_image: "Nano Banana  ",
    ai_prompt: " AI ",
    dormant: "   ",
    latest_hash: " Hash",
    prev: "",
    block: "",
    loading: "...",
    login_failed: " ",
    geo_error: "",
    planting: "...",
    minting: "...",
    creating: "...",
    map_view: " ",
    list_view: " ",
    upload_photo: "  ",
    validated: "",
    unvalidated: "",
    validate_action: "  ",
    cant_plant: "    ",
    match_pulse: " /  ?",
    quick_snap: " ",
    back_forest: " ",
    genesis: "  (Genesis Hash)",
    steward: "",
    location: "",
    tree_details: " ",
    profile: "",
    my_trees: " ",
    my_pulses: " ",
    my_matches: " ",
    joined: "",
    total_love: " "
  },
  ja: {
    forest: "",
    pulses: " ()",
    visions: " ()",
    oracle: "",
    sign_in: "",
    sign_out: "",
    emit_pulse: "",
    plant_lifetree: "",
    create_vision: "",
    connect_roots: "",
    tree_name: "",
    vision: "",
    title: "",
    body: "",
    webpage: "Web",
    mint: " (NFT)",
    generate: "",
    generate_image: "Nano Banana",
    ai_prompt: "AI",
    dormant: "",
    latest_hash: "",
    prev: "",
    block: "",
    loading: "...",
    login_failed: "",
    geo_error: "",
    planting: "...",
    minting: "...",
    creating: "...",
    map_view: "",
    list_view: "",
    upload_photo: "",
    validated: "",
    unvalidated: "",
    validate_action: "",
    cant_plant: "",
    match_pulse: " / ",
    quick_snap: "",
    back_forest: "",
    genesis: "",
    steward: "",
    location: "",
    tree_details: "",
    profile: "",
    my_trees: "",
    my_pulses: "",
    my_matches: "",
    joined: "",
    total_love: ""
  },
  ar: {
    forest: "",
    pulses: "",
    visions: "",
    oracle: "",
    sign_in: "",
    sign_out: "",
    emit_pulse: " ",
    plant_lifetree: "  ",
    create_vision: " ",
    connect_roots: " .",
    tree_name: " ",
    vision: "",
    title: "",
    body: "",
    webpage: " ",
    mint: " ",
    generate: "",
    generate_image: "  Nano Banana",
    ai_prompt: "  ",
    dormant: " .",
    latest_hash: " ",
    prev: "",
    block: "",
    loading: "...",
    login_failed: " ",
    geo_error: "  ",
    planting: "...",
    minting: "...",
    creating: "...",
    map_view: "",
    list_view: "",
    upload_photo: " ",
    validated: "",
    unvalidated: " ",
    validate_action: "  ",
    cant_plant: "      .",
    match_pulse: " /   ",
    quick_snap: " ",
    back_forest: " ",
    genesis: " ",
    steward: "",
    location: "",
    tree_details: " ",
    profile: " ",
    my_trees: "",
    my_pulses: "",
    my_matches: "",
    joined: "",
    total_love: " "
  }
};


=== ./README.md ===
<div align="center">
<img width="1200" height="475" alt="GHBanner" src="https://github.com/user-attachments/assets/0aa67016-6eaf-458a-adb2-6e31a0763ed6" />
</div>

# Run and deploy your AI Studio app

This contains everything you need to run your app locally.

View your app in AI Studio: https://ai.studio/apps/drive/1eBSglJJDv9P5IVCTX6YihXiQBwDVGWAg

## Run Locally

**Prerequisites:**  Node.js


1. Install dependencies:
   `npm install`
2. Set the `API_KEY` in `.env` to your Gemini API key (see `.env.example`).
3. Set the Firebase configuration keys in `.env` (see `.env.example`).
4. Run the app:
   `npm run dev`

=== ./types.ts ===

import { type User as FirebaseUser } from 'firebase/auth';
import { type Timestamp } from 'firebase/firestore';

export type Lightseed = Pick<FirebaseUser, 'uid' | 'email' | 'displayName' | 'photoURL'>;

export type PulseType = 'STANDARD' | 'GROWTH';

// The Entity/Blockchain container
export interface Lifetree {
  id: string;
  ownerId: string;
  name: string;
  body: string; // The Vision
  imageUrl?: string;
  latitude?: number;
  longitude?: number;
  locationName?: string;
  createdAt: Timestamp;
  
  // Validation Logic
  validated: boolean; 
  validatorId?: string;

  // Blockchain Props
  genesisHash: string;
  latestHash: string; 
  blockHeight: number;
}

export interface Vision {
  id: string;
  lifetreeId: string;
  authorId: string;
  title: string;
  body: string;
  link?: string;
  imageUrl?: string;
  createdAt: Timestamp;
}

// The Block
export interface Pulse {
  id: string;
  lifetreeId: string;
  type: PulseType; // GROWTH or STANDARD
  
  // Data Payload
  title: string;
  body: string;
  imageUrl?: string;
  
  // Match Logic (On Chain)
  isMatch: boolean;
  matchedLifetreeId?: string;
  matchId?: string; // Link to the handshake
  
  // Metadata
  authorId: string;
  authorName: string;
  authorPhoto?: string;
  createdAt: Timestamp;
  
  // Interactions (Off Chain)
  loveCount: number;
  commentCount: number;

  // Blockchain Ledger
  previousHash: string;
  hash: string;
}

// Off-Chain Match Handshake
export interface MatchProposal {
  id: string;
  initiatorPulseId: string;
  initiatorTreeId: string;
  initiatorUid: string;
  
  targetPulseId: string; // The pulse being matched WITH
  targetTreeId: string;
  targetUid: string; // The owner who needs to accept

  status: 'PENDING' | 'ACCEPTED' | 'REJECTED';
  createdAt: Timestamp;
}

export interface Comment {
  id: string;
  body: string;
  authorId: string;
  authorName: string;
  createdAt: Timestamp;
}


=== ./components/Logo.tsx ===

import React, { useId } from 'react';

interface LogoProps {
  className?: string;
  width?: number;
  height?: number;
}

const Logo: React.FC<LogoProps> = ({ className, width = 64, height = 64 }) => {
  const uniqueId = useId();
  const clipPathId = `clean-${uniqueId}`;

  return (
    <svg 
      width={width} 
      height={height} 
      viewBox="0 0 262 262" 
      xmlns="http://www.w3.org/2000/svg"
      className={className}
    >
      <defs>
        <clipPath id={clipPathId}>
          <circle cx="131" cy="131" r="131" />
        </clipPath>
      </defs>
      <g>
        <circle cx="131" cy="131" r="131" fill="white" stroke="#334155" strokeWidth="7" clipPath={`url(#${clipPathId})`} />

        {/* Left Column */}
        <circle cx="-35.28" cy="-29" r="64" fill="none" stroke="#334155" strokeWidth=".7" clipPath={`url(#${clipPathId})`} />
        <circle cx="-35.28" cy="35" r="64" fill="none" stroke="#334155" strokeWidth=".7" clipPath={`url(#${clipPathId})`} />
        <circle cx="-35.28" cy="99" r="64" fill="none" stroke="#334155" strokeWidth=".7" clipPath={`url(#${clipPathId})`} />
        <circle cx="-35.28" cy="163" r="64" fill="none" stroke="#334155" strokeWidth=".7" clipPath={`url(#${clipPathId})`} />
        <circle cx="-35.28" cy="227" r="64" fill="none" stroke="#334155" strokeWidth=".7" clipPath={`url(#${clipPathId})`} />
        <circle cx="-35.28" cy="291" r="64" fill="none" stroke="#334155" strokeWidth=".7" clipPath={`url(#${clipPathId})`} />

        {/* Mid-Left Column */}
        <circle cx="20.15" cy="3" r="64" fill="none" stroke="#334155" strokeWidth=".7" clipPath={`url(#${clipPathId})`} />
        <circle cx="20.15" cy="67" r="64" fill="none" stroke="#334155" strokeWidth=".7" clipPath={`url(#${clipPathId})`} />
        <circle cx="20.15" cy="131" r="64" fill="none" stroke="#334155" strokeWidth=".7" clipPath={`url(#${clipPathId})`} />
        <circle cx="20.15" cy="195" r="64" fill="none" stroke="#334155" strokeWidth=".7" clipPath={`url(#${clipPathId})`} />
        <circle cx="20.15" cy="259" r="64" fill="none" stroke="#334155" strokeWidth=".7" clipPath={`url(#${clipPathId})`} />

        {/* Center Column */}
        <circle cx="75.57" cy="-29" r="64" fill="none" stroke="#334155" strokeWidth=".7" clipPath={`url(#${clipPathId})`} />
        <circle cx="75.57" cy="35" r="64" fill="none" stroke="#334155" strokeWidth=".7" clipPath={`url(#${clipPathId})`} />
        <circle cx="75.57" cy="99" r="64" fill="none" stroke="#334155" strokeWidth=".7" clipPath={`url(#${clipPathId})`} />
        <circle cx="75.57" cy="163" r="64" fill="none" stroke="#334155" strokeWidth=".7" clipPath={`url(#${clipPathId})`} />
        <circle cx="75.57" cy="227" r="64" fill="none" stroke="#334155" strokeWidth=".7" clipPath={`url(#${clipPathId})`} />
        <circle cx="75.57" cy="291" r="64" fill="none" stroke="#334155" strokeWidth=".7" clipPath={`url(#${clipPathId})`} />

        {/* Mid-Right Column */}
        <circle cx="131" cy="3" r="64" fill="none" stroke="#334155" strokeWidth=".7" clipPath={`url(#${clipPathId})`} />
        <circle cx="131" cy="67" r="64" fill="none" stroke="#334155" strokeWidth=".7" clipPath={`url(#${clipPathId})`} />
        <circle cx="131" cy="131" r="64" fill="none" stroke="#334155" strokeWidth=".7" clipPath={`url(#${clipPathId})`} />
        <circle cx="131" cy="195" r="64" fill="none" stroke="#334155" strokeWidth=".7" clipPath={`url(#${clipPathId})`} />
        <circle cx="131" cy="259" r="64" fill="none" stroke="#334155" strokeWidth=".7" clipPath={`url(#${clipPathId})`} />

        {/* Right Columns */}
        <circle cx="186.43" cy="-29" r="64" fill="none" stroke="#334155" strokeWidth=".7" clipPath={`url(#${clipPathId})`} />
        <circle cx="186.43" cy="35" r="64" fill="none" stroke="#334155" strokeWidth=".7" clipPath={`url(#${clipPathId})`} />
        <circle cx="186.43" cy="99" r="64" fill="none" stroke="#334155" strokeWidth=".7" clipPath={`url(#${clipPathId})`} />
        <circle cx="186.43" cy="163" r="64" fill="none" stroke="#334155" strokeWidth=".7" clipPath={`url(#${clipPathId})`} />
        <circle cx="186.43" cy="227" r="64" fill="none" stroke="#334155" strokeWidth=".7" clipPath={`url(#${clipPathId})`} />
        <circle cx="186.43" cy="291" r="64" fill="none" stroke="#334155" strokeWidth=".7" clipPath={`url(#${clipPathId})`} />

        <circle cx="241.85" cy="3" r="64" fill="none" stroke="#334155" strokeWidth=".7" clipPath={`url(#${clipPathId})`} />
        <circle cx="241.85" cy="67" r="64" fill="none" stroke="#334155" strokeWidth=".7" clipPath={`url(#${clipPathId})`} />
        <circle cx="241.85" cy="131" r="64" fill="none" stroke="#334155" strokeWidth=".7" clipPath={`url(#${clipPathId})`} />
        <circle cx="241.85" cy="195" r="64" fill="none" stroke="#334155" strokeWidth=".7" clipPath={`url(#${clipPathId})`} />
        <circle cx="241.85" cy="259" r="64" fill="none" stroke="#334155" strokeWidth=".7" clipPath={`url(#${clipPathId})`} />

        <circle cx="297.28" cy="-29" r="64" fill="none" stroke="#334155" strokeWidth=".7" clipPath={`url(#${clipPathId})`} />
        <circle cx="297.28" cy="35" r="64" fill="none" stroke="#334155" strokeWidth=".7" clipPath={`url(#${clipPathId})`} />
        <circle cx="297.28" cy="99" r="64" fill="none" stroke="#334155" strokeWidth=".7" clipPath={`url(#${clipPathId})`} />
        <circle cx="297.28" cy="163" r="64" fill="none" stroke="#334155" strokeWidth=".7" clipPath={`url(#${clipPathId})`} />
        <circle cx="297.28" cy="227" r="64" fill="none" stroke="#334155" strokeWidth=".7" clipPath={`url(#${clipPathId})`} />
        <circle cx="297.28" cy="291" r="64" fill="none" stroke="#334155" strokeWidth=".7" clipPath={`url(#${clipPathId})`} />

        {/* Inner Seed Circles */}
        <circle cx="75.57" cy="99" r="16" fill="white" stroke="#334155" strokeWidth="3" clipPath={`url(#${clipPathId})`} />
        <circle cx="75.57" cy="163" r="16" fill="white" stroke="#334155" strokeWidth="3" clipPath={`url(#${clipPathId})`} />
        <circle cx="131" cy="67" r="16" fill="white" stroke="#334155" strokeWidth="3" clipPath={`url(#${clipPathId})`} />
        <circle cx="131" cy="131" r="16" fill="white" stroke="#334155" strokeWidth="3" clipPath={`url(#${clipPathId})`} />
        <circle cx="131" cy="195" r="16" fill="white" stroke="#334155" strokeWidth="3" clipPath={`url(#${clipPathId})`} />
        <circle cx="186.43" cy="99" r="16" fill="white" stroke="#334155" strokeWidth="3" clipPath={`url(#${clipPathId})`} />
        <circle cx="186.43" cy="163" r="16" fill="white" stroke="#334155" strokeWidth="3" clipPath={`url(#${clipPathId})`} />
      </g>
    </svg>
  );
};

export default Logo;


=== ./package.json ===
{
  "name": "lifeseed.online",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "react": "^19.2.0",
    "react-dom": "^19.2.0",
    "@google/genai": "^1.27.0",
    "firebase": "^12.6.0"
  },
  "devDependencies": {
    "@types/node": "^22.14.0",
    "@vitejs/plugin-react": "^5.0.0",
    "typescript": "~5.8.2",
    "vite": "^6.2.0"
  }
}


=== ./.github/workflows/firebase-hosting-pull-request.yml ===
# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to Firebase Hosting on PR
on: pull_request
permissions:
  checks: write
  contents: read
  pull-requests: write
jobs:
  build_and_preview:
    if: ${{ github.event.pull_request.head.repo.full_name == github.repository }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: npm ci && npm run build
      - uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_LIFESEED_7CDB0 }}
          projectId: lifeseed-7cdb0


=== ./.github/workflows/firebase-hosting-merge.yml ===
# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to Firebase Hosting on merge
on:
  push:
    branches:
      - main
jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: npm ci && npm run build
      - uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_LIFESEED_7CDB0 }}
          channelId: live
          projectId: lifeseed-7cdb0


=== ./tsconfig.json ===
{
  "compilerOptions": {
    "target": "ES2022",
    "experimentalDecorators": true,
    "useDefineForClassFields": false,
    "module": "ESNext",
    "lib": [
      "ES2022",
      "DOM",
      "DOM.Iterable"
    ],
    "skipLibCheck": true,
    "types": [
      "node"
    ],
    "moduleResolution": "bundler",
    "isolatedModules": true,
    "moduleDetection": "force",
    "allowJs": true,
    "jsx": "react-jsx",
    "paths": {
      "@/*": [
        "./*"
      ]
    },
    "allowImportingTsExtensions": true,
    "noEmit": true
  }
}

=== ./firebase.json ===
{
  "firestore": {
    "rules": "firestore.rules",
    "indexes": "firestore.indexes.json"
  },
  "hosting": {
    "public": "dist",
    "ignore": [
      "firebase.json",
      "**/.*",
      "**/node_modules/**"
    ],
    "rewrites": [
      {
        "source": "**",
        "destination": "/index.html"
      }
    ]
  },
  "storage": {
    "rules": "storage.rules"
  }
}

=== ./vite.config.ts ===

import path from 'path';
import { defineConfig, loadEnv } from 'vite';
import react from '@vitejs/plugin-react';

export default defineConfig(({ mode }) => {
    // Use process.cwd() to ensure we look in the project root for .env
    const env = loadEnv(mode, process.cwd(), '');
    return {
      server: {
        port: 3000,
        host: '0.0.0.0',
      },
      plugins: [react()],
      define: {
        // Expose loaded env vars as a global constant
        '__STATIC_ENV__': JSON.stringify(env),
        // Remap process.env to window.process.env to support runtime injection + static build
        // This satisfies esbuild (it's a simple identifier replacement)
        'process.env': 'window.process.env',
      },
      resolve: {
        alias: {
          '@': path.resolve(__dirname, '.'),
        }
      }
    };
});


=== ./flat.sh ===
#!/bin/bash

# Output file for flattened project
OUTPUT_FILE="${1:-flattened_project.txt}"

# Check if this is a Git repository
if [ ! -d .git ]; then
  echo "Error: This doesn't seem to be a Git repository (no .git directory found)."
  exit 1
fi

# Clear output file
> "$OUTPUT_FILE"

# Counters for summary
INCLUDED_COUNT=0
EXCLUDED_COUNT=0

# Image extensions to exclude
IMAGE_EXTENSIONS="\.png$|\.jpg$|\.jpeg$|\.gif$|\.bmp$|\.webp$|\.ico$|\.svg$"

# Function to check if a file is ignored by .gitignore
is_ignored() {
  local path="$1"
  path="${path#./}"
  git check-ignore -q "$path" 2>/dev/null && return 0
  local parent="$path"
  while [ "$parent" != "." ] && [ "$parent" != "/" ]; do
    parent=$(dirname "$parent")
    git check-ignore -q "$parent" 2>/dev/null && return 0
  done
  return 1
}

# Function to check if a file is text-based
is_text_file() {
  local file="$1"
  local ext="${file##*.}"
  case "$ext" in
    ts|tsx|js|jsx|css|json|html|md|txt|sh|yml|yaml)
      return 0
      ;;
    *)
      return 1
      ;;
  esac
}

# Find and process files
find . -type f -not -path '*/node_modules/*' -not -path '*/.git/*' | while read -r file; do
  # Skip output file, lock files, and Firebase cache
  if [ "$file" = "./$OUTPUT_FILE" ] ||
     [[ "$file" == *"/bun.lockb" ]] ||
     [[ "$file" == *"/package-lock.json" ]] ||
     [[ "$file" == *"/.firebase/"* ]]; then
    ((EXCLUDED_COUNT++))
    continue
  fi

  # Skip image files
  if echo "$file" | grep -E -q "$IMAGE_EXTENSIONS"; then
    ((EXCLUDED_COUNT++))
    continue
  fi

  # Skip ignored files
  if is_ignored "$file"; then
    ((EXCLUDED_COUNT++))
    continue
  fi

  # Include text-based files
  if is_text_file "$file"; then
    echo "=== $file ===" >> "$OUTPUT_FILE"
    cat "$file" >> "$OUTPUT_FILE"
    echo -e "\n" >> "$OUTPUT_FILE"
    ((INCLUDED_COUNT++))
  else
    ((EXCLUDED_COUNT++))
  fi
done

# Print summary
echo "Flattened project written to: $OUTPUT_FILE"
echo "Summary: Included $INCLUDED_COUNT files, excluded $EXCLUDED_COUNT files"

=== ./services/firebase.ts ===

import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  onAuthStateChanged,
  GoogleAuthProvider,
  signInWithPopup,
  type User as FirebaseUser,
  signOut as firebaseSignOut
} from 'firebase/auth';
import { 
  initializeFirestore, 
  collection, 
  query, 
  orderBy, 
  getDocs, 
  addDoc,
  serverTimestamp,
  doc,
  runTransaction,
  getDoc,
  where,
  updateDoc,
  deleteDoc,
  limit
} from 'firebase/firestore';
import { 
  getStorage, 
  ref, 
  uploadBytes, 
  getDownloadURL,
  uploadString
} from 'firebase/storage';
import { type Pulse, type PulseType, type Lifetree, type MatchProposal, type Vision } from '../types';
import { createBlock } from '../utils/crypto';

// We use process.env because vite.config.ts explicitly polyfills it to merge 
// local .env vars with runtime injected vars (window.process.env).
// This prevents "undefined" errors that can happen with import.meta.env in some environments.
const firebaseConfig = {
  apiKey: process.env.VITE_FIREBASE_API_KEY,
  authDomain: process.env.VITE_FIREBASE_AUTH_DOMAIN,
  projectId: process.env.VITE_FIREBASE_PROJECT_ID,
  storageBucket: process.env.VITE_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: process.env.VITE_FIREBASE_MESSAGING_SENDER_ID,
  appId: process.env.VITE_FIREBASE_APP_ID
};

if (!firebaseConfig.apiKey || firebaseConfig.apiKey.includes("YOUR_")) {
  console.warn("LifeSeed Configuration Warning: .env file might be missing or invalid.");
}

const app = initializeApp(firebaseConfig);
export const auth = getAuth(app);
export const db = initializeFirestore(app, {
    ignoreUndefinedProperties: true
});
export const storage = getStorage(app);
const googleProvider = new GoogleAuthProvider();

// --- AUTH ---
export const onAuthChange = (callback: (user: FirebaseUser | null) => void) => {
  return onAuthStateChanged(auth, callback);
};

export const signInWithGoogle = async () => {
  try { return (await signInWithPopup(auth, googleProvider)).user; } 
  catch (error) { console.error(error); throw error; }
};

export const logout = () => firebaseSignOut(auth);

// --- STORAGE ---
export const uploadImage = async (file: File, path: string): Promise<string> => {
  try {
    const storageRef = ref(storage, path);
    await uploadBytes(storageRef, file);
    return await getDownloadURL(storageRef);
  } catch (error) { console.error(error); throw error; }
};

export const uploadBase64Image = async (base64String: string, path: string): Promise<string> => {
  try {
    const storageRef = ref(storage, path);
    await uploadString(storageRef, base64String, 'data_url');
    return await getDownloadURL(storageRef);
  } catch (error) { console.error(error); throw error; }
}

// --- LIFETREES ---
const lifetreesCollection = collection(db, 'lifetrees');
const visionsCollection = collection(db, 'visions');

export const plantLifetree = async (data: {
  ownerId: string, 
  name: string, 
  body: string, 
  imageUrl?: string,
  lat?: number,
  lng?: number,
  locName?: string
}) => {
  // Check if user already has an unvalidated tree
  const q = query(lifetreesCollection, where('ownerId', '==', data.ownerId));
  const snapshot = await getDocs(q);
  
  if (!snapshot.empty) {
      const trees = snapshot.docs.map(d => d.data() as Lifetree);
      const allValidated = trees.every(t => t.validated);
      if (!allValidated) {
          throw new Error("Your existing Lifetree is not validated yet. You cannot plant another.");
      }
  }

  // Check if this is the FIRST tree in the entire system (Genesis)
  const allTreesQuery = query(lifetreesCollection, limit(1));
  const allTreesSnap = await getDocs(allTreesQuery);
  const isFirstTree = allTreesSnap.empty;

  const isValid = isFirstTree || data.name.trim().toLowerCase() === "phoenix";
  const genesisData = { message: "Genesis Pulse", owner: data.ownerId, timestamp: Date.now() };
  const genesisHash = await createBlock("0", genesisData, Date.now());

  const treeDoc = await addDoc(lifetreesCollection, {
    ownerId: data.ownerId,
    name: data.name,
    body: data.body,
    imageUrl: data.imageUrl || null,
    latitude: data.lat || null,
    longitude: data.lng || null,
    locationName: data.locName || "Unknown Soil",
    createdAt: serverTimestamp(),
    genesisHash: genesisHash,
    latestHash: genesisHash,
    blockHeight: 0,
    validated: isValid,
    validatorId: isValid ? (isFirstTree ? "GENESIS" : "SYSTEM") : null
  });

  // Automatically create the first Vision (Branch) for this tree
  await addDoc(visionsCollection, {
      lifetreeId: treeDoc.id,
      authorId: data.ownerId,
      title: "Root Vision",
      body: data.body, // The Vision comes from the tree planting
      imageUrl: data.imageUrl || null,
      createdAt: serverTimestamp(),
      link: ""
  });

  return treeDoc;
};

export const validateLifetree = async (targetTreeId: string, validatorTreeId: string) => {
    const targetRef = doc(db, 'lifetrees', targetTreeId);
    const validatorRef = doc(db, 'lifetrees', validatorTreeId);

    return runTransaction(db, async (t) => {
        const vDoc = await t.get(validatorRef);
        const tDoc = await t.get(targetRef);

        if (!vDoc.exists() || !tDoc.exists()) throw new Error("Tree not found");
        
        const validator = vDoc.data() as Lifetree;
        if (!validator.validated) throw new Error("Only a Validated Lifetree can validate others.");

        t.update(targetRef, {
            validated: true,
            validatorId: validatorTreeId
        });
    });
}

export const fetchLifetrees = async (): Promise<Lifetree[]> => {
  const q = query(lifetreesCollection, orderBy('createdAt', 'desc'));
  const querySnapshot = await getDocs(q);
  return querySnapshot.docs.map(doc => ({ id: doc.id, ...(doc.data() as any) } as Lifetree));
};

export const getMyLifetrees = async (userId: string): Promise<Lifetree[]> => {
    if (!userId) return [];
    const q = query(lifetreesCollection, where('ownerId', '==', userId));
    const snapshot = await getDocs(q);
    return snapshot.docs.map(doc => ({ id: doc.id, ...(doc.data() as any) } as Lifetree));
};

// --- VISIONS ---
export const fetchVisions = async (): Promise<Vision[]> => {
    const q = query(visionsCollection, orderBy('createdAt', 'desc'));
    const snap = await getDocs(q);
    return snap.docs.map(d => ({id: d.id, ...(d.data() as any)} as Vision));
}

export const getMyVisions = async (userId: string): Promise<Vision[]> => {
    if (!userId) return [];
    const q = query(visionsCollection, where('authorId', '==', userId));
    const snap = await getDocs(q);
    return snap.docs.map(d => ({id: d.id, ...(d.data() as any)} as Vision));
}

export const createVision = async (data: {
    lifetreeId: string,
    authorId: string,
    title: string,
    body: string,
    link?: string,
    imageUrl?: string
}) => {
    return addDoc(visionsCollection, {
        ...data,
        createdAt: serverTimestamp()
    });
}

// --- PULSES & MATCHING ---
const pulsesCollection = collection(db, 'pulses');
const matchesCollection = collection(db, 'matches');

export const fetchPulses = async (): Promise<Pulse[]> => {
  const q = query(pulsesCollection, orderBy('createdAt', 'desc'));
  const querySnapshot = await getDocs(q);
  return querySnapshot.docs.map(doc => ({ id: doc.id, ...(doc.data() as any) } as Pulse));
};

export const getMyPulses = async (userId: string): Promise<Pulse[]> => {
    if (!userId) return [];
    // Note: Use orderBy client-side if missing index
    const q = query(pulsesCollection, where('authorId', '==', userId));
    const snapshot = await getDocs(q);
    const pulses = snapshot.docs.map(doc => ({ id: doc.id, ...(doc.data() as any) } as Pulse));
    return pulses.sort((a,b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
};

export const fetchGrowthPulses = async (treeId: string): Promise<Pulse[]> => {
    // Removed orderBy to prevent 'Missing Index' errors on new deployments.
    // Sorting happens client-side.
    const q = query(
        pulsesCollection, 
        where('lifetreeId', '==', treeId), 
        where('type', '==', 'GROWTH')
    );
    const snap = await getDocs(q);
    const pulses = snap.docs.map(doc => ({ id: doc.id, ...(doc.data() as any) } as Pulse));
    // Client-side sort
    return pulses.sort((a,b) => (a.createdAt?.toMillis() || 0) - (b.createdAt?.toMillis() || 0));
}

// Mint a single Pulse (Growth or Standard)
export const mintPulse = async (pulseData: {
  lifetreeId: string,
  type: PulseType,
  title: string,
  body: string,
  imageUrl?: string,
  authorId: string,
  authorName: string,
  authorPhoto?: string,
}) => {
  return runTransaction(db, async (transaction) => {
    const timestamp = Date.now();
    
    const sourceTreeRef = doc(db, 'lifetrees', pulseData.lifetreeId);
    const sourceTreeDoc = await transaction.get(sourceTreeRef);
    if (!sourceTreeDoc.exists()) throw new Error("Source tree missing");
    
    const sourceTree = sourceTreeDoc.data() as Lifetree;
    const prevHashSource = sourceTree.latestHash || sourceTree.genesisHash || "0";
    
    // Hash Payload (excludes comments)
    const blockData = {
      title: pulseData.title,
      body: pulseData.body,
      image: pulseData.imageUrl || "",
      author: pulseData.authorId,
      type: pulseData.type
    };
    
    const newHash = await createBlock(prevHashSource, blockData, timestamp);
    const newPulseRef = doc(pulsesCollection);
    
    transaction.set(newPulseRef, {
      ...pulseData,
      id: newPulseRef.id,
      isMatch: false,
      loveCount: 0,
      commentCount: 0,
      createdAt: serverTimestamp(),
      previousHash: prevHashSource,
      hash: newHash,
    });

    transaction.update(sourceTreeRef, {
      latestHash: newHash,
      blockHeight: (sourceTree.blockHeight || 0) + 1,
      // If growth, maybe update tree image? Optional.
      ...(pulseData.type === 'GROWTH' && pulseData.imageUrl ? { imageUrl: pulseData.imageUrl } : {})
    });
  });
};

// --- MATCHING SYSTEM ---

export const proposeMatch = async (data: {
    initiatorPulseId: string,
    initiatorTreeId: string,
    initiatorUid: string,
    targetPulseId: string,
    targetTreeId: string, // Requires us to look up the pulse's tree first usually
    targetUid: string
}) => {
    return addDoc(matchesCollection, {
        ...data,
        status: 'PENDING',
        createdAt: serverTimestamp()
    });
}

export const getPendingMatches = async (userId: string): Promise<MatchProposal[]> => {
    const q = query(matchesCollection, where('targetUid', '==', userId), where('status', '==', 'PENDING'));
    const snap = await getDocs(q);
    return snap.docs.map(d => ({id: d.id, ...d.data() as any} as MatchProposal));
}

// Get completed matches where user was involved
export const getMyMatchesHistory = async (userId: string): Promise<MatchProposal[]> => {
    // Requires multiple queries or an OR clause (not fully supported in simple queries without index)
    // Simpler: Fetch accepted matches for target, accepted for initiator
    const q1 = query(matchesCollection, where('targetUid', '==', userId), where('status', '==', 'ACCEPTED'));
    const q2 = query(matchesCollection, where('initiatorUid', '==', userId), where('status', '==', 'ACCEPTED'));
    
    const [s1, s2] = await Promise.all([getDocs(q1), getDocs(q2)]);
    const matches = [...s1.docs, ...s2.docs].map(d => ({id: d.id, ...d.data() as any} as MatchProposal));
    return matches.sort((a,b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
}

// Accepts match and writes to blockchain
export const acceptMatch = async (proposalId: string) => {
    const matchRef = doc(db, 'matches', proposalId);
    
    return runTransaction(db, async (t) => {
        const matchDoc = await t.get(matchRef);
        if (!matchDoc.exists()) throw new Error("Match expired");
        const proposal = matchDoc.data() as MatchProposal;

        if (proposal.status !== 'PENDING') throw new Error("Match already processed");

        // Mint Match Block on Initiator Tree
        const initTreeRef = doc(db, 'lifetrees', proposal.initiatorTreeId);
        const initTree = (await t.get(initTreeRef)).data() as Lifetree;
        const initHash = await createBlock(initTree.latestHash, { match: proposal.id, with: proposal.targetPulseId }, Date.now());
        
        const pulseRef1 = doc(pulsesCollection);
        t.set(pulseRef1, {
            lifetreeId: proposal.initiatorTreeId,
            type: 'STANDARD',
            title: 'Pulse Match',
            body: 'Two pulses met and connected.',
            isMatch: true,
            matchedLifetreeId: proposal.targetTreeId,
            matchId: proposal.id,
            authorId: proposal.initiatorUid,
            authorName: 'System', 
            createdAt: serverTimestamp(),
            previousHash: initTree.latestHash,
            hash: initHash,
            loveCount: 0,
            commentCount: 0
        });
        t.update(initTreeRef, { latestHash: initHash, blockHeight: initTree.blockHeight + 1 });

        // Mint Match Block on Target Tree
        const targetTreeRef = doc(db, 'lifetrees', proposal.targetTreeId);
        const targetTree = (await t.get(targetTreeRef)).data() as Lifetree;
        const targetHash = await createBlock(targetTree.latestHash, { match: proposal.id, with: proposal.initiatorPulseId }, Date.now());

        const pulseRef2 = doc(pulsesCollection);
        t.set(pulseRef2, {
            lifetreeId: proposal.targetTreeId,
            type: 'STANDARD',
            title: 'Pulse Match',
            body: 'Two pulses met and connected.',
            isMatch: true,
            matchedLifetreeId: proposal.initiatorTreeId,
            matchId: proposal.id,
            authorId: proposal.targetUid,
            authorName: 'System',
            createdAt: serverTimestamp(),
            previousHash: targetTree.latestHash,
            hash: targetHash,
            loveCount: 0,
            commentCount: 0
        });
        t.update(targetTreeRef, { latestHash: targetHash, blockHeight: targetTree.blockHeight + 1 });

        // Close Proposal
        t.update(matchRef, { status: 'ACCEPTED' });
    });
}

// --- INTERACTIONS (Off Chain) ---

export const isPulseLoved = async (pulseId: string, userId: string): Promise<boolean> => {
    if (!userId) return false;
    const loveDocRef = doc(db, 'pulses', pulseId, 'loves', userId);
    const docSnap = await getDoc(loveDocRef);
    return docSnap.exists();
};

export const lovePulse = async (pulseId: string, userId: string): Promise<number> => {
  const pulseRef = doc(db, 'pulses', pulseId);
  const loveRef = doc(pulseRef, 'loves', userId);

  return runTransaction(db, async (transaction) => {
    const postDoc = await transaction.get(pulseRef);
    if (!postDoc.exists()) throw new Error("Pulse dissolved.");
    
    const loveDoc = await transaction.get(loveRef);
    let newLoveCount = postDoc.data().loveCount || 0;

    if (loveDoc.exists()) {
      transaction.delete(loveRef);
      newLoveCount = Math.max(0, newLoveCount - 1);
    } else {
      transaction.set(loveRef, { userId, createdAt: serverTimestamp() });
      newLoveCount += 1;
    }
    
    transaction.update(pulseRef, { loveCount: newLoveCount });
    return newLoveCount;
  });
};


=== ./services/gemini.ts ===

import { GoogleGenAI, GenerateContentResponse, Chat } from "@google/genai";

// Helper to get a fresh client instance every time.
// This ensures we capture the API Key if it is injected dynamically by the UI (window.aistudio).
const getAiClient = (): GoogleGenAI | null => {
    // process.env.API_KEY is the strict requirement.
    // We access it dynamically to support runtime injection.
    const apiKey = process.env.API_KEY ? process.env.API_KEY.trim() : "";
    
    if (!apiKey) {
        console.warn("LifeSeed: process.env.API_KEY is missing. Please select an API key via the UI or check your .env file.");
        return null;
    }
    
    return new GoogleGenAI({ apiKey });
}

export const generatePostTitle = async (body: string): Promise<string> => {
  if (!body.trim()) {
    return "";
  }
  
  const ai = getAiClient();
  if (!ai) return "";

  try {
    const prompt = `Generate a short, engaging title (maximum 10 words) for the following post body. Do not use quotation marks in the title:\n\n---\n${body}\n---`;
    
    const response: GenerateContentResponse = await ai.models.generateContent({
      model: 'gemini-2.5-flash',
      contents: prompt,
    });

    return response.text ? response.text.trim().replace(/["']/g, '') : ""; // Remove quotes

  } catch (error) {
    console.error("Error generating title with Gemini:", error);
    return "";
  }
};

export const generateLifetreeBio = async (seed: string): Promise<string> => {
  if (!seed.trim()) return "";
  
  const ai = getAiClient();
  if (!ai) {
      // Return a fallback so the UI doesn't crash, but warn user
      console.warn("Gemini API Key missing");
      return "Roots run deep... (Please connect AI Key via the Key icon)";
  }

  try {
    const prompt = `
      You are LifeSeed AI, a poetic and nature-loving assistant.
      The user wants to grow a "Lifetree" (a digital profile representation of their soul).
      They provided this seed thought: "${seed}".
      
      Write a short (max 40 words), mystical, and nature-inspired bio/description for their Lifetree.
      It should sound organic, peaceful, and connected to the earth.
    `;

    const response: GenerateContentResponse = await ai.models.generateContent({
        model: 'gemini-2.5-flash',
        contents: prompt,
    });
    
    return response.text ? response.text.trim() : "";
  } catch (error) {
    console.error("Error generating bio:", error);
    return "The forest whispers quietly... (AI Error)";
  }
}

// Generate Image for Visions (Nano Banana)
export const generateVisionImage = async (prompt: string): Promise<string | null> => {
    if (!prompt.trim()) return null;
    const ai = getAiClient();
    if (!ai) {
        throw new Error("API Key Missing. Please ensure API_KEY is set in your .env file or connected via the UI.");
    }

    try {
        console.log("Generating vision image with Nano Banana...");
        const response = await ai.models.generateContent({
            model: 'gemini-2.5-flash-image', // Nano Banana
            contents: [
                { 
                    parts: [{ text: `A mystical, nature-inspired, abstract painting representing: ${prompt}` }] 
                }
            ],
            config: {
                imageConfig: {
                    aspectRatio: "1:1",
                    // imageSize is NOT supported by gemini-2.5-flash-image
                }
            }
        });

        // The response will contain base64 image data
        for (const part of response.candidates?.[0]?.content?.parts || []) {
            if (part.inlineData) {
                return `data:${part.inlineData.mimeType};base64,${part.inlineData.data}`;
            }
        }
        console.warn("Nano Banana: No image data returned in response.");
        return null;
    } catch (e: any) {
        console.error("Error generating image:", e);
        
        // Handle Rate Limiting / Quota issues specifically
        const errorMsg = e.toString().toLowerCase();
        if (errorMsg.includes("429") || errorMsg.includes("quota") || errorMsg.includes("resource_exhausted")) {
             throw new Error("Daily quota or rate limit exceeded. Please wait 30 seconds and try again.");
        }
        if (errorMsg.includes("key not valid") || errorMsg.includes("api_key_invalid") || errorMsg.includes("403")) {
            throw new Error("Invalid API Key. Please check your .env file or re-select your key using the Key icon.");
        }

        // Throw specific error message to be caught by UI
        throw new Error(e.message || "Unknown GenAI Error");
    }
}

// New Chat Interface
export const createOracleChat = (systemInstruction?: string) => {
    const ai = getAiClient();
    if (!ai) throw new Error("API Key Missing");

    return ai.chats.create({
        model: 'gemini-2.5-flash',
        config: {
            systemInstruction: systemInstruction || "You are the LifeSeed Oracle, an ancient digital spirit of the forest. You speak in metaphors, trees, and roots. You are wise, calm, and helpful, but always maintain your mystical forest persona. Keep answers relatively short and poetic.",
        }
    });
}


=== ./firestore.indexes.json ===
{
  "indexes": [],
  "fieldOverrides": []
}

